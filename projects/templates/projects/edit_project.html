<!-- templates/projects/edit_project.html -->
<html>
<head>
    <title>Правка - {{ project.name }}</title>
    {% load static %}
    <script src="{% static 'js/jquery-3.7.1.min.js' %}"></script>
    <link rel="stylesheet" type="text/css" href="{% static 'projects/yandex-map-modal.css' %}">
    <script src="https://api-maps.yandex.ru/2.1/?apikey=<212ad00a-2b33-4742-9805-36eb9352e2df>&lang=ru_RU" type="text/javascript"></script>
</head>
<body>
    <h1>{{ project.name }}</h1>
    <form id="project-form" method="POST" enctype="multipart/form-data">
        {% csrf_token %}
        {{ form.as_p }}
    </form>
    <p id="remaining-requests">Осталось {{ remaining_requests }} запросов</p>
    <button type="button" id="get-coordinates-btn">Получить координаты</button>
    <div id="loading-indicator" style="display: none;">Идет парсинг адресов, пожалуйста подождите...</div>
    <a href="{% url 'create_event' project.id %}">Создать событие</a>
    <ul>
        {% for event in events %}
        <li>
            <a href="{% url 'edit_event' event.id %}">
                {{ event.get_event_type_display }} {{ event.event_date }}
            </a>
            <form method="POST" action="{% url 'delete_event' event.id %}" style="display:inline;">
                {% csrf_token %}
                <button type="submit" onclick="return confirm('Вы уверены что хотите удалить событие?');">Удалить</button>
            </form>
        </li>
        {% empty %}
            <li>Нет событий.</li>
        {% endfor %}
    </ul>
    
    <h2>Список адресов</h2>
    <ul id="addresses-list">
        {% for address in addresses %}
        <li data-id="{{ address.id }}">
            <span class="address-number">{{ forloop.counter }}.</span> 
            <input class="address-name" value="{{ address.name }}" data-id="{{ address.id }}"> |
            <span class="latitude">{{ address.latitude }}</span>
            <button class="show-map-btn" data-latitude="{{ address.latitude }}" data-longitude="{{ address.longitude }}">Карта</button> 
            <span class="longitude">{{ address.longitude }}</span>
            <button class="delete-address-btn" data-id="{{ address.id }}">Удалить</button>
        </li>
        {% empty %}
        <li>Нет адресов.</li>
        {% endfor %}
    </ul>
    <div id="map-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div id="map" style="width: 600px; height: 400px;"></div>
        </div>
    </div>
    <button type="button" id="add-address-btn">Добавить адрес</button>
    <button type="button" id="update-addresses-btn">Обновить список</button>
    <button type="button" id="delete-addresses-btn">Удалить список</button>
    <button type="button" id="save-project-button">Сохранить проект</button>
    <a href="{% url 'manage_projects' %}">Закрыть</a>
    <script>
        $(document).ready(function() {
            $('#save-project-button').click(function() {
                $('#project-form').submit();
            });
        });
    </script>
    <script>
        document.getElementById('get-coordinates-btn').addEventListener('click', function() {
            const btn = this;
            if (btn.disabled) return;

            document.getElementById('loading-indicator').style.display = 'block';
            const formData = new FormData();
            formData.append('excel_file', document.querySelector('input[type="file"]').files[0]);
            fetch("{% url 'get_coordinates' project.id %}", {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('loading-indicator').style.display = 'none';

                if (data.status === 'ok') {
                    const addressList = document.getElementById('addresses-list');
                    data.addresses.forEach(html => {
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = html;
                        addressList.appendChild(tempDiv.firstElementChild); // Добавляем новые адреса к существующему списку
                    });
                    addDeleteEventListeners(); // Повторное добавление обработчиков событий
                    updateAddressNumbers() // Обновление нумерации списка

                    // Обновление оставшихся запросов
                    updateRemainingRequestsCount(data.remaining_requests);
                } else {
                    alert(data.message || 'Ошибка при получении координат');
                    if (data.message && data.message.includes('Закончились запросы')) {
                        btn.disabled = true;  // Отключение кнопки при исчерпании запросов
                    }
                }

                // Обновление оставшегося количества запросов независимо от статуса
                updateRemainingRequestsCount(data.remaining_requests);
            })
            .catch(error => {
                document.getElementById('loading-indicator').style.display = 'none';
                console.error('Error:', error);
                alert('Ошибка сети');
            });
        });

        function updateRemainingRequestsCount(count) {
            document.getElementById('remaining-requests').innerText = `Осталось ${count} запросов`;
        }
    
        function addDeleteEventListeners() {
            document.querySelectorAll('.delete-address-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const li = button.closest('li');
                    // Дополнительная логика для удаления из БД может быть добавлена здесь
                    li.remove(); // Удаление элемента из DOM
                });
            });
        }
    
        function updateRemainingRequestsCount(count) {
            document.getElementById('remaining-requests').textContent = `Осталось ${count} запросов`;
        }
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Обработка редактирования адреса
            document.querySelectorAll('.address-name').forEach(input => {
                input.addEventListener('change', function() {
                    const addressId = this.getAttribute('data-id');
                    const newName = this.value;
                    
                    fetch(`{% url 'edit_address_name' project.id %}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({ id: addressId, new_name: newName })
                    });
                });
            });

            // Обработка удаления адреса
            document.querySelectorAll('.delete-address-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const addressId = this.getAttribute('data-id');
                    
                    fetch(`{% url 'delete_address' project.id %}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({ id: addressId })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'ok') {
                            this.parentElement.remove();
                        } else {
                            alert('Ошибка при удалении адреса');
                        }
                    });
                });
            });
        });
        // яндекс карта
        document.querySelectorAll('.show-map-btn').forEach(button => {
            button.addEventListener('click', function() {
                // Получаем координаты из атрибутов data
                const latStr = this.getAttribute('data-latitude');
                const lonStr = this.getAttribute('data-longitude');

                // Заменяем запятую на точку, если она присутствует
                const latitude = parseFloat(latStr.replace(',', '.'));
                const longitude = parseFloat(lonStr.replace(',', '.'));

                const modal = document.getElementById('map-modal');
                modal.style.display = "block";

                // Удаление старой карты, чтобы создать каждую карту с нужными координатами
                while (document.getElementById('map').firstChild) {
                    document.getElementById('map').removeChild(document.getElementById('map').firstChild);
                }

                ymaps.ready(() => {
                    const map = new ymaps.Map("map", {
                        center: [latitude, longitude],
                        zoom: 14
                    });
                    const placemark = new ymaps.Placemark([latitude, longitude], {}, {
                        preset: 'islands#icon',
                        iconColor: '#0095b6'
                    });
                    map.geoObjects.add(placemark);
                });
            });
        });

        document.querySelector('.close').addEventListener('click', function() {
            document.getElementById('map-modal').style.display = "none";
        });

        window.addEventListener('click', function(event) {
            const modal = document.getElementById('map-modal');
            if (event.target === modal) {
                modal.style.display = "none";
            }
        });
        document.getElementById('add-address-btn').addEventListener('click', function() {
            const addressList = document.getElementById('addresses-list');
            const newListItem = document.createElement('li');

            // Создаем новый элемент списка с пустыми данными
            newListItem.innerHTML = `
                <span class="address-number">${addressList.children.length + 1}.</span>
                <input type="text" name="new_address_names[]" class="address-name" placeholder="Введите название адреса">
                <span class="latitude"></span> | <span class="longitude"></span>
                <button type="button" class="delete-address-btn">Удалить</button>
            `;

            addressList.appendChild(newListItem);
            newListItem.querySelector('.delete-address-btn').addEventListener('click', function() {
                addressList.removeChild(newListItem);
                updateAddressNumbers();
            });
        });

        document.getElementById('update-addresses-btn').onclick = function() {
            const newAddresses = document.querySelectorAll('input[name="new_address_names[]"]');
            const data = Array.from(newAddresses).map(input => input.value).filter(name => name.trim() !== '');

            fetch("{% url 'update_addresses' project.id %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ 
                    new_addresses: data 
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'ok') {
                    alert('Адреса успешно обновлены');
                    updateRemainingRequestsCount(data.remaining_requests);
                    location.reload();
                } else {
                    alert(data.message || 'Произошла ошибка при обновлении адресов');
                }
            })
            .catch(error => {
                console.error('Ошибка:', error);
                alert('Ошибка сети');
            });
        };

        function updateRemainingRequestsCount(count) {
            document.getElementById('remaining-requests').innerText = `Осталось ${count} запросов`;
        }

        function updateAddressNumbers() {
            const addressNumbers = document.querySelectorAll('.address-number');
            addressNumbers.forEach((span, index) => {
                span.textContent = `${index + 1}.`;
            });
        }

        document.getElementById('delete-addresses-btn').addEventListener('click', function() {
            if (!confirm('Вы уверены, что хотите удалить все адреса?')) {
                return;
            }
    
            fetch("{% url 'delete_addresses' project.id %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                },
            })
            .then(response => {
                if (response.ok) {
                    // Очистите список адресов на странице
                    document.getElementById('addresses-list').innerHTML = '<li>Нет адресов.</li>';
                } else {
                    alert('Ошибка при удалении адресов');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Ошибка сети');
            });
        });
    </script>
</body>
</html>