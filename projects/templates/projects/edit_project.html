<!-- templates/projects/edit_project.html -->
<!DOCTYPE html>
<html lang="ru_RU">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Правка - {{ project.name }}</title>
    {% load static %}
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="{% static 'css/normalize.css' %}">
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/edit-project.css' %}">
    <script src="{% static 'js/jquery-3.7.1.min.js' %}"></script>
    <!-- <script src="//code.jquery.com/ui/1.12.1/jquery-ui.js"></script> -->
    <script src="{% static 'js/jquery-ui.1.12.1.min.js' %}"></script>
    <script src="https://api-maps.yandex.ru/2.1/?apikey={{ api_key }}&lang=ru_RU" type="text/javascript"></script>
    
</head>
<body class="page project">
    <header class="page__header">
        <nav class="nav">
            <ul class="nav__list">
                <li class="nav__item">
                    <a class="nav__link nav__link--inactive" href="{% url 'profile' %}">Профиль</a>
                </li>
                <li class="nav__item">
                    <a class="nav__link nav__link--active">Проекты</a>
                </li>
                <li class="nav__item">
                    <a class="nav__link nav__link--inactive" href="{% url 'events_control' %}">Контроль</a>
                </li>
            </ul>
        </nav>
        <div class="logo">
            <img class="logo__img" src="{% static 'img/logo.png' %}" alt="Логотип">
        </div>
    </header>
    <div class="container">
        <header class="project__header">
            <h1 class="page__title">{{ project.name }}</h1>
            <button class="project__save-btn btn" type="button" id="save-project-button">Сохранить проект</button>
            <a class="project__close-btn" href="{% url 'manage_projects' %}"></a>
        </header>
        <div class="project__content">
            <div class="project__content-row">
                <div class="project__content-col">
                    <div class="project__content-cell" data-section-id="details">
                        <div class="project__cell-header" data-section-id="details">
                            <h2 class="page__block-title">Детали</h2>
                        </div>
                        <div class="project__cell-content" data-section-id="details">
                            <div class="project__cell-content-wrap">
                                <form class="project__form" id="project-form" method="POST" enctype="multipart/form-data">
                                    {% csrf_token %}
                                    <div class="project__form-field">
                                        <label for="{{ form.name.id_for_label }}">Название</label>
                                        {{ form.name }}
                                    </div>
                                    <div class="project__form-field">
                                        <label for="{{ form.organization.id_for_label }}">Организация взаимодействия</label>
                                        {{ form.organization }}
                                    </div>
                                    <div class="project__form-field" id="new-organization-field" style="display: none;">
                                        <label for="{{ form.new_organization.id_for_label }}">Новая организация</label>
                                        {{ form.new_organization }}
                                    </div>
                                    <div class="project__form-field">
                                        <label for="{{ form.product.id_for_label }}">Продукция взаимодействия</label>
                                        {{ form.product }}
                                    </div>
                                    <div class="project__form-field">
                                        <label for="{{ form.description.id_for_label }}">Описание</label>
                                        {{ form.description }}
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    <div class="project__content-cell" data-section-id="events">
                        <div class="project__cell-header" data-section-id="events">
                            <h2 class="page__block-title">События</h2>
                        </div>
                        <div class="project__cell-content" data-section-id="events">
                            <div class="project__cell-content-wrap">
                                <ul class="project__events-list">
                                    {% for event in events %}
                                    <li class="project__events-item">
                                        <a class="project__events-link" href="{% url 'edit_event' event.id %}">
                                            {{ event.get_event_type_display }} {{ event.event_date }}
                                        </a>
                                        <span class="project__events-status">{{ event.get_status_display }}</span>
                                        <form class="project__events-delete-form" method="POST" action="{% url 'delete_event' event.id %}" style="display:inline;">
                                            {% csrf_token %}
                                            <button class="project__events-delete-btn btn" type="submit" onclick="return confirm('Вы уверены что хотите удалить событие?');">Удалить</button>
                                        </form>
                                    </li>
                                    {% empty %}
                                    <li class="project__events-item">Нет событий.</li>
                                    {% endfor %}
                                </ul>
                                <a class="project__events-creat-link" href="{% url 'create_event' project.id %}">Создать</a>
                            </div>
                        </div>
                    </div>
                    <div class="project__content-cell" data-section-id="addresses">
                        <div class="project__cell-header" data-section-id="addresses">
                            <h2 class="page__block-title">Список адресов</h2>
                        </div>
                        <div class="project__cell-content" data-section-id="addresses">
                            <div class="project__cell-content-wrap">
                                <div class="file-upload">
                                    <div class="file-upload-wrap">
                                        <div class="file-upload-choice">
                                            <button type="button" class="file-button">Excel файл</button>
                                            <input type="file" id="id_excel_file" style="display: none;">
                                            <span class="file-name">не выбран</span>
                                        </div>
                                        <button class="get-coordinates-btn btn" type="button" id="get-coordinates-btn">Добавить адреса</button>
                                    </div>
                                    <span class="remaining-requests" id="remaining-requests">{{ remaining_requests }}</span>
                                </div>
                                <div class="loading-indicator" id="loading-indicator" style="display: none;">Идет парсинг адресов, пожалуйста подождите...</div>
                                <ul class="project__addresses-list" id="addresses-list">
                                    {% for address in addresses %}
                                    <li class="project__addresses-item" data-id="{{ address.id }}">
                                        <span class="address-number">={{ forloop.counter }}=</span>
                                        <input class="address-name" value="{{ address.name }}" data-id="{{ address.id }}">
                                        <div class="hidden-coordinates">
                                            <span class="latitude">{{ address.latitude }}</span> | 
                                            <span class="longitude">{{ address.longitude }}</span>
                                        </div>
                                        <button class="delete-address-btn btn" data-id="{{ address.id }}">Удалить</button>
                                    </li>
                                    {% empty %}
                                    <li class="project__addresses-item no-addresses">Нет адресов.</li>
                                    {% endfor %}
                                </ul>
                                <div class="project__addresses-list-btns">
                                    <div class="project__addresses-list-btns-wrap">
                                        <button class="add-address-btn btn" type="button" id="add-address-btn">Добавить адрес</button>
                                        <button class="update-addresses-btn btn" type="button" id="update-addresses-btn">Обновить список</button>
                                    </div>
                                    <button class="delete-addresses-btn btn" type="button" id="delete-addresses-btn">Удалить список</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="project__content-col">
                    <div class="map-wrap">
                        <div id="map" style="width: 100%; height: 100%;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            // Проверка, есть ли в списке адресов любые элементы, которые не содержат текст "Нет адресов."
            var hasAddresses = $('#addresses-list li').not(':contains("Нет адресов.")').length > 0;
            
            if (!hasAddresses) {
                // Если адресов нет, скрыть блок с кнопками
                $('.project__addresses-list-btns').hide();
            }

            // Проверка на наличие API Key
            const apiKey = "{{ user.profile.api_key }}"; // Предполагаем, что API Key передан в контекст
            if (!apiKey) {
                alert("Вам нужно заполнить поле API Key в профиле.");
                return;
            }

            ymaps.ready(initMap);
        });

        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('id_excel_file');
            const fileButton = document.querySelector('.file-button');
            const fileNameDisplay = document.querySelector('.file-name');
            const getCoordinatesBtn = document.getElementById('get-coordinates-btn');

            if (fileInput && fileButton && fileNameDisplay && getCoordinatesBtn) {
                // Открытие диалога выбора файла при клике на кнопку
                fileButton.addEventListener('click', function() {
                    fileInput.click();
                });

                // Обновление текста и стиля кнопки при выборе файла
                fileInput.addEventListener('change', function(event) {
                    const fileName = event.target.files.length ? event.target.files[0].name : 'не выбран';
                    fileNameDisplay.textContent = fileName;

                    // Изменяем цвет фона кнопки, если файл был выбран
                    if (event.target.files.length) {
                        getCoordinatesBtn.style.backgroundColor = 'rgb(129, 172, 85)';
                    } else {
                        // Восстанавливаем цвет фона по умолчанию, если файл не выбран
                        getCoordinatesBtn.style.backgroundColor = '';
                    }
                });
            }
        });

        $(document).ready(function() {
            // Инициализация состояния аккордеона
            $('.project__content-cell').each(function() {
                const sectionId = $(this).data('section-id');
                console.log(`Processing section: ${sectionId}`);
                
                // Получаем состояние из localStorage
                let isOpen = localStorage.getItem(`accordion-${sectionId}`);

                if (isOpen === null) {
                    isOpen = 'false';
                    localStorage.setItem(`accordion-${sectionId}`, isOpen);
                }

                isOpen = isOpen === 'true';
                console.log(`Section ${sectionId} isOpen: ${isOpen}`);

                if (isOpen) {
                    $(this).find('.project__cell-content').show();
                    $(this).find('.project__cell-header').addClass('project__cell-header--active');
                } else {
                    $(this).find('.project__cell-content').hide();
                    $(this).find('.project__cell-header').removeClass('project__cell-header--active');
                }
            });

            $('.project__cell-header').on('click', function() {
                const section = $(this).closest('.project__content-cell');
                const sectionId = section.data('section-id');

                // Переключение отображения содержимого
                $(this).next('.project__cell-content').slideToggle(function() {
                    const isOpen = $(this).is(':visible');
                    localStorage.setItem(`accordion-${sectionId}`, isOpen.toString());
                    console.log(`Updated section ${sectionId} isOpen: ${isOpen}`); // Отладка
                });

                $(this).toggleClass('project__cell-header--active');
            });
        });

        $(document).ready(function() {
            // сохранение проекта
            $('#save-project-button').click(function() {
                $('#project-form').submit();
            });
            // поле для новой организации
            $('#id_organization').change(function() {
                if ($(this).val() == 'add_new') {
                    $('#new-organization-field').show();
                } else {
                    $('#new-organization-field').hide();
                }
            }).change(); // Trigger change to update on load
        });

        // обновление счётчика запросов
        function updateRemainingRequests() {
            fetch('{% url "get_remaining_requests" %}', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}', // Если включена защита CSRF
                },
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('remaining-requests').innerText = `${data.remaining_requests}`;
            })
            .catch(error => console.error('Ошибка при обновлении оставшихся запросов:', error));
        }

        // Запрашиваем сервер каждый час, чтобы обновить данные
        setInterval(updateRemainingRequests, 60 * 60 * 1000);  // Каждые 60 минут

        // Проверяем время до полуночи и запускаем обновление в полночь
        const timeUntilMidnight = '{{ seconds_until_midnight }}';
        setTimeout(updateRemainingRequests, timeUntilMidnight * 1000);
    </script>
    <script>
        document.getElementById('get-coordinates-btn').addEventListener('click', function() {
            const btn = this;
            if (btn.disabled) return;

            const fileInput = document.querySelector('input[type="file"]');
            
            if (!fileInput.files || fileInput.files.length === 0) {
                alert('Excel файл не выбран!');
                return;  // Прекращаем выполнение, если файл не выбран
            }

            document.getElementById('loading-indicator').style.display = 'block';
            const formData = new FormData();
            formData.append('excel_file', fileInput.files[0]);
            
            fetch("{% url 'get_coordinates' project.id %}", {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('loading-indicator').style.display = 'none';

                if (data.status === 'ok') {
                    const addressList = document.getElementById('addresses-list');
                    addressList.innerHTML = ''; // Очистка текущего списка адресов

                    data.addresses.forEach(html => {
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = html;
                        addressList.appendChild(tempDiv.firstElementChild); // Добавляем новые адреса к списку
                    });

                    // Показываем блок с кнопками, так как адреса теперь добавлены
                    document.querySelector('.project__addresses-list-btns').style.display = 'flex';

                    // Пересоздаём карту, чтобы обновить метки
                    initMap();

                    addDeleteEventListeners(); // Повторное добавление обработчиков событий
                    updateAddressNumbers(); // Обновление нумерации списка

                } else {
                    alert(data.message || 'Ошибка при получении координат');
                    if (data.message && data.message.includes('Закончились запросы')) {
                        btn.disabled = true;  // Отключение кнопки при исчерпании запросов
                    }
                }

                // Обновление оставшегося количества запросов независимо от статуса
                updateRemainingRequestsCount(data.remaining_requests);
            })
            .catch(error => {
                document.getElementById('loading-indicator').style.display = 'none';
                console.error('Error:', error);
                alert('Ошибка сети');
            });
        });
    
        function addDeleteEventListeners() {
            document.querySelectorAll('.delete-address-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const li = button.closest('li');
                    // Дополнительная логика для удаления из БД может быть добавлена здесь
                    li.remove(); // Удаление элемента из DOM
                });
            });
        }
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Обработка редактирования адреса
            document.querySelectorAll('.address-name').forEach(input => {
                input.addEventListener('change', function() {
                    const addressId = this.getAttribute('data-id');
                    const newName = this.value;
                    
                    fetch(`{% url 'edit_address_name' project.id %}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({ id: addressId, new_name: newName })
                    });
                });
            });

            // Обработка удаления адреса
            document.querySelectorAll('.delete-address-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const addressId = this.getAttribute('data-id');
                    const addressName = this.parentElement.querySelector('.address-name').value;

                    const confirmation = window.confirm(`Удалить адрес - ${addressName}?`);
                    if (!confirmation) {
                        return; // Если пользователь не подтвердил действие, выйти из функции
                    }

                    fetch(`{% url 'delete_address' project.id %}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({ id: addressId })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'ok') {
                            this.parentElement.remove();
                            updateAddressNumbers();
                        } else {
                            alert('Ошибка при удалении адреса');
                        }
                    })
                    .catch(error => {
                        console.error('Ошибка:', error);
                        alert('Ошибка сети');
                    });
                });
            });
        });
        
        // Глобальная переменная для карты
        var map;

        function initMap() {
            // Создаём карту только в первый раз
            if (!map) {
                map = new ymaps.Map('map', {
                    center: [55.76, 37.64], // Начальная позиция - Москва
                    zoom: 10
                });
            }

            // Очищаем все предыдущие метки
            map.geoObjects.removeAll();

            // Создаем массив для хранения координат меток
            let coordinates = [];

            // Добавление меток на карту
            $('#addresses-list li').each(function() {
                var latitudeText = $(this).find('.latitude').text().trim();
                var longitudeText = $(this).find('.longitude').text().trim();
                var name = $(this).find('.address-name').val() || '';
                var addressNumber = $(this).find('.address-number').text().trim().replace('.', '');

                var latitude = parseFloat(latitudeText.replace(',', '.'));
                var longitude = parseFloat(longitudeText.replace(',', '.'));

                if (!isNaN(latitude) && !isNaN(longitude)) {
                    var placemark = new ymaps.Placemark(
                        [latitude, longitude], 
                        {
                            balloonContent: `<strong>${addressNumber}</strong> ${name}`,
                            iconContent: addressNumber
                        }, 
                        {
                            preset: 'islands#redStretchyIcon'
                        }
                    );

                    map.geoObjects.add(placemark);
                    coordinates.push([latitude, longitude]);
                } else {
                    console.warn('Некорректные координаты для адреса:', name);
                }
            });

            if (coordinates.length > 1) {
                var polyline = new ymaps.Polyline(coordinates, {}, {
                    strokeColor: '#0000FF',
                    strokeWidth: 3,
                    strokeOpacity: 0.5
                });

                map.geoObjects.add(polyline);
            }
        }

        // Инициализируем карту, как только документ готов
        $(document).ready(function() {
            // Проверка на наличие API Key
            const apiKey = "{{ user.profile.api_key }}"; // Предполагаем, что API Key передан в контекст
            if (!apiKey) {
                alert("Вам нужно заполнить поле API Key в профиле.");
                return;
            }

            ymaps.ready(initMap);
        });

        // функция сортировки списка адресов
        $(document).ready(function() {
            $('#addresses-list').sortable({
                placeholder: 'ui-state-highlight',
                update: function(project, ui) {
                    updateAddressNumbersAfterSort();
                    saveNewOrder();
                }
            });
            $('#addresses-list').disableSelection();

            function updateAddressNumbersAfterSort() {
                $('#addresses-list li').each(function(index) {
                    $(this).find('.address-number').text('=' + (index + 1) + '=');
                });
            }

            function saveNewOrder() {
                const orderData = [];
                $('#addresses-list li').each(function(index) {
                    const addressId = $(this).data('id');
                    orderData.push({ id: addressId, order: index });
                });

                $.ajax({
                    url: "{% url 'update_address_order' %}",
                    type: "POST",
                    data: {
                        order: JSON.stringify(orderData),
                        model: 'Address', // добавлено 
                        csrfmiddlewaretoken: "{{ csrf_token }}"
                    },
                    success: function(response) {
                        console.log('Порядок адресов проекта успешно сохранен.');
                        // Обновляем карту после успешного изменения порядка адресов
                        if (map) initMap();
                    },
                    error: function(response) {
                        console.error('Ошибка при сохранении порядка адресов проекта');
                    }
                });
            }
        });

        document.getElementById('add-address-btn').addEventListener('click', function() {
            const addressList = document.getElementById('addresses-list');
            const newListItem = document.createElement('li');
            newListItem.classList.add('project__addresses-item');

            // Создаем новый элемент списка с пустыми данными
            newListItem.innerHTML = `
                <span class="address-number">=${addressList.children.length + 1}=</span>
                <input type="text" name="new_address_names[]" class="address-name" placeholder="Введите название адреса">
                <div class="hidden-coordinates">
                    <span class="latitude"></span>
                    <span class="longitude"></span>
                </div>
                <button type="button" class="delete-address-btn btn">Удалить</button>
            `;

            addressList.appendChild(newListItem);
            newListItem.querySelector('.delete-address-btn').addEventListener('click', function() {
                addressList.removeChild(newListItem);
                updateAddressNumbers();
            });
        });

        document.getElementById('update-addresses-btn').onclick = function() {
            const newAddresses = document.querySelectorAll('input[name="new_address_names[]"]');
            const data = Array.from(newAddresses).map(input => input.value).filter(name => name.trim() !== '');

            fetch("{% url 'update_addresses' project.id %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ 
                    new_addresses: data 
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'ok') {
                    alert('Адреса успешно обновлены');
                    updateRemainingRequestsCount(data.remaining_requests);
                    location.reload();
                } else {
                    alert(data.message || 'Произошла ошибка при обновлении адресов');
                }
            })
            .catch(error => {
                console.error('Ошибка:', error);
                alert('Ошибка сети');
            });
        };

        function updateRemainingRequestsCount(count) {
            document.getElementById('remaining-requests').innerText = `${count}`;
        }

        function updateAddressNumbers() {
            const addressNumbers = document.querySelectorAll('.address-number');
            addressNumbers.forEach((span, index) => {
                span.textContent = `=${index + 1}=`;
            });
        }

        document.getElementById('delete-addresses-btn').addEventListener('click', function() {
            if (!confirm('Вы уверены, что хотите удалить все адреса?')) {
                return;
            }
    
            fetch("{% url 'delete_addresses' project.id %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                },
            })
            .then(response => {
                if (response.ok) {
                    // Очистите список адресов на странице
                    document.getElementById('addresses-list').innerHTML = '<li class="no-addresses">Нет адресов.</li>';
                    // Скрываем блок с кнопками управления адресами
                    document.querySelector('.project__addresses-list-btns').style.display = 'none';
                } else {
                    alert('Ошибка при удалении адресов');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Ошибка сети');
            });
        });
    </script>
</body>
<footer class="page__footer">

</footer>
</html>