<!-- templates/projects/edit_event.html -->
<html>
<head>
    <title>Правка события - {{ event.get_event_type_display }}</title>
    {% load static %}
    <script src="{% static 'js/jquery-3.7.1.min.js' %}"></script>
    <link rel="stylesheet" type="text/css" href="{% static 'projects/yandex-map-modal.css' %}">
    <script src="https://api-maps.yandex.ru/2.1/?apikey={{ api_key }}&lang=ru_RU" type="text/javascript"></script>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="//code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
</head>
<body>
    <h1>Правка события: {{ event.get_event_type_display }} | {{ project.name }}</h1>
    <form id="event-form" method="POST">
        {% csrf_token %}
        {{ form.as_p }}
    </form>
    
    <button type="button" id="copy-addresses-btn">Добавить адреса</button>
    <span id="remaining-requests">Осталось {{ remaining_requests }} запросов</span>
    <h2>Адреса для события</h2>
    <ul id="event-addresses-list">
        {% for address in event.addresses.all %}
        <li data-id="{{ address.id }}" data-user-assigned="{% if address.assigned_user %}true{% else %}false{% endif %}">
            <span class="address-number">{{ forloop.counter }}.</span> 
            <input class="address-name" value="{{ address.name }}" data-id="{{ address.id }}"> |
            <span class="latitude">{{ address.latitude }}</span> | 
            <span class="longitude">{{ address.longitude }}</span>
            <button class="delete-address-btn" data-id="{{ address.id }}">Удалить</button>
            {% if address.assigned_user %}
                {% with address.assigned_user.executorprofile as profile %}
                    <span class="executor-name">{{ profile.name|default:address.assigned_user.username }}</span>
                {% endwith %}
            {% else %}
                <span class="executor-name">Не назначен</span>
            {% endif %}
        </li>
        {% empty %}
        <li>Нет адресов.</li>
        {% endfor %}
    </ul>

    <button type="button" id="add-address-btn">Добавить адрес</button>
    <button type="button" id="update-addresses-btn">Обновить список</button>
    <button type="button" id="show-map-btn">Показать карту</button>
    <!-- Кнопка для выбора исполнителей -->
    <button type="button" id="select-executors-btn">Выбрать исполнителей</button>

    <!-- Список исполнителей -->
    <h2>Список исполнителей для события</h2>
    <ul id="event-executors-list">
        {% for event_user in event_users %}
            {% if event_user.user.executorprofile %}
            <li data-id="{{ event_user.user.id }}" data-status="{{ event_user.status }}">
                <span class="user-name">{{ event_user.user.executorprofile.name|default:event_user.user.email }}</span>
                {% if event_user.user.executorprofile.district %} | <span class="district">{{ event_user.user.executorprofile.district }}</span>{% endif %}
                {% if event_user.user.executorprofile.phone_number %} | <span class="phone-number">{{ event_user.user.executorprofile.phone_number }}</span>{% endif %}
                <span class="status"> | статус: {{ event_user.get_status_display }}</span>
    
                {% if event_users.count > 1 %}
                    <label for="address-indexes-{{ event_user.user.id }}">Номера адресов: </label>
                    <input type="text" id="address-indexes-{{ event_user.user.id }}" placeholder="Например: 1,3-5,10-20,25">
                {% endif %}
                <button class="assign-btn" data-id="{{ event_user.user.id }}">Назначить</button>
                <button class="delete-executor-btn" data-id="{{ event_user.user.id }}">Удалить</button>
            </li>
            {% else %}
            <li>У пользователя нет профиля исполнителя.</li>
            {% endif %}
        {% empty %}
            <li>Нет исполнителей.</li>
        {% endfor %}
    </ul>

    <!-- Модальное окно для выбора исполнителей -->
    <div id="executor-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>Выберите исполнителей</h3>
            <ul id="executor-selection-list">
                {% for user in executors %}
                    {% with user.executorprofile as profile %}
                    <li>
                        <input type="checkbox" id="executor-{{ profile.user.id }}" data-id="{{ profile.user.id }}" data-name="{{ profile.name|default:user.email }}">
                        <label for="executor-{{ profile.user.id }}">
                            <span class="user-name">{{ profile.name|default:user.email }}</span>
                            {% if profile.district %} | <span class="district">{{ profile.district }}</span>{% endif %}
                            {% if profile.phone_number %} | <span class="phone-number">{{ profile.phone_number }}</span>{% endif %}
                        </label>
                    </li>
                    {% endwith %}
                {% endfor %}
            </ul>
            <button type="button" id="add-executors-btn">Выбрать</button>
        </div>
    </div>

    <div id="map-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div id="map" style="width: 600px; height: 400px;"></div>
            <ul id="modal-event-addresses-list">
                {% for address in event.addresses.all %}
                <li data-id="{{ address.id }}">
                    <span class="address-number">{{ forloop.counter }}.</span> 
                    <input class="address-name" value="{{ address.name }}" data-id="{{ address.id }}"> | 
                    <span class="latitude">{{ address.latitude }}</span> | 
                    <span class="longitude">{{ address.longitude }}</span>
                </li>
                {% empty %}
                <li>Нет адресов.</li>
                {% endfor %}
            </ul>
        </div>
    </div>
    <button type="button" id="save-event-button">Сохранить событие</button>
    <a href="{% url 'edit_project' project.id %}">Назад</a>

    <script>
        // обновление счётчика запросов
        function updateRemainingRequests() {
            fetch('{% url "get_remaining_requests" %}', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}', // Если включена защита CSRF
                },
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('remaining-requests').innerText = `Осталось ${data.remaining_requests} запросов`;
            })
            .catch(error => console.error('Ошибка при обновлении оставшихся запросов:', error));
        }

        // Запрашиваем сервер каждый час, чтобы обновить данные
        setInterval(updateRemainingRequests, 60 * 60 * 1000);  // Каждые 60 минут

        // Проверяем время до полуночи и запускаем обновление в полночь
        const timeUntilMidnight = '{{ seconds_until_midnight }}';
        setTimeout(updateRemainingRequests, timeUntilMidnight * 1000);
        $(document).ready(function() {
            // сохранение события
            $('#save-event-button').click(function() {
                $('#event-form').submit();
            });
            // Функция для проверки статусов исполнителей
            function checkExecutorsStatus() {
                let allowCopy = true; // По умолчанию разрешаем копирование адресов

                // Проходим по каждому исполнителю
                $('#event-executors-list li').each(function() {
                    const statusText = $(this).find('.status').text().trim();
                    
                    // Проверяем, содержит ли статус запрещенные значения
                    if (statusText.includes('Назначено') || 
                        statusText.includes('Подтверждено') || 
                        statusText.includes('Отказ') || 
                        statusText.includes('В работе') || 
                        statusText.includes('Завершено')) {
                        allowCopy = false;
                        return false; // Выходим из цикла, так как копирование уже запрещено
                    }
                });

                // Устанавливаем кнопку активной или неактивной в зависимости от условия
                $('#copy-addresses-btn').prop('disabled', !allowCopy);
            }

            // Изначально проверяем статусы при загрузке страницы
            checkExecutorsStatus();
            // Синхронизация адресов с проекта
            $('#copy-addresses-btn').click(function() {
                const eventId = "{{ event.id }}";  // Получаем ID текущего события
                $.ajax({
                    url: "{% url 'copy_addresses' event.id %}",  // URL, на который будет отправлен POST-запрос
                    type: "POST",
                    data: {
                        csrfmiddlewaretoken: "{{ csrf_token }}",
                    },
                    success: function(response) {
                        alert('Адреса были успешно добавлены');
                        
                        // Обновить список адресов
                        $('#event-addresses-list').empty(); // Очистить текущий список адресов
                        
                        // Перебрать полученные адреса и добавить их в список
                        response.addresses.forEach(function(address, index) {
                            const listItem = `
                                <li data-id="${address.id}">
                                    <span class="address-number">${index + 1}.</span> 
                                    <input class="address-name" value="${address.name}" data-id="${address.id}"> |
                                    <span class="latitude">${address.latitude}</span>
                                    <span class="longitude">${address.longitude}</span>
                                    <button class="delete-address-btn" data-id="${address.id}">Удалить</button>
                                </li>
                            `;
                            $('#event-addresses-list').append(listItem);
                        });
                        location.reload();
                    },
                    error: function(response) {
                        if (response.responseJSON && response.responseJSON.error) {
                            alert(response.responseJSON.error);
                        } else {
                            alert('Произошла ошибка при добавлении адресов');
                        }
                    }
                });
            });
            // Обработка удаления конкретного адреса
            $('#event-addresses-list').on('click', '.delete-address-btn', function() {
                const listItem = $(this).closest('li');
                const addressId = listItem.data('id');
                const isUserAssigned = listItem.attr('data-user-assigned') === 'true'; // Используйте attr, если data возвращает unexpected results

                // Добавьте отладочный вывод
                console.log('Удаление адреса: ', addressId);
                console.log('Назначен исполнитель:', isUserAssigned);

                if (isUserAssigned) {
                    const confirmationMessage = "Вы действительно хотите удалить адрес, который назначен исполнителю? Будут удалены имеющиеся фото к этому адресу!";
                    
                    // Еще один отладочный вывод для подтверждения
                    console.log('Отображаем подтверждение');
                    
                    if (!confirm(confirmationMessage)) {
                        console.log('Удаление отменено');
                        return; // Если пользователь отменил подтверждение, ничего не делаем
                    }
                }

                // Если дошли до сюда, значит, пользователь подтвердил или подтверждение не требовалось
                $.ajax({
                    url: "{% url 'delete_event_address' 0 %}".replace('/0/', '/' + addressId + '/'),
                    type: "POST",
                    data: {
                        csrfmiddlewaretoken: "{{ csrf_token }}",
                    },
                    success: function(response) {
                        listItem.remove();  // Удаляем элемент из DOM после успешного удаления из БД
                        updateAddressNumbers(); // Обновляем нумерацию оставшихся адресов
                    },
                    error: function(response) {
                        alert('Произошла ошибка при удалении адреса');
                    }
                });
            });

            document.getElementById('add-address-btn').onclick = function() {
                const addressList = document.getElementById('event-addresses-list');
                
                // Создаем новый элемент списка без данных
                const newListItem = document.createElement('li');
                newListItem.innerHTML = `
                    <span class="address-number">${addressList.children.length + 1}.</span>
                    <input type="text" name="new_address_names[]" class="address-name" placeholder="Введите название адреса">
                    <span class="latitude"></span> | <span class="longitude"></span>
                    <button type="button" class="delete-address-btn">Удалить</button>
                `;
                
                addressList.appendChild(newListItem);
                updateAddressNumbers();
                
                newListItem.querySelector('.delete-address-btn').onclick = function() {
                    addressList.removeChild(newListItem);
                    updateAddressNumbers();
                };
            };

            // Функция для обновления нумерации адресов
            function updateAddressNumbers() {
                $('#event-addresses-list .address-number').each(function(index) {
                    $(this).text((index + 1) + '.');
                });
            }

            document.getElementById('update-addresses-btn').onclick = async function () {
                const apiKey = "{{ user.profile.api_key }}"; // Предполагаем, что API Key передан в контекст

                // Проверяем, заполнен ли API KEY
                if (!apiKey) {
                    alert("Вам нужно заполнить поле API Key в профиле");
                    return; // Прерываем выполнение функции
                }

                // Проверка корректности API Key
                let isValidApiKey = await checkApiKeyValidity(apiKey);
                if (!isValidApiKey) {
                    alert("Ваш API Key недействителен. Пожалуйста, проверьте его корректность.");
                    return;
                }

                const addressList = document.getElementById('event-addresses-list');
                const newAddresses = [];

                for (let i = 0; i < addressList.children.length; i++) {
                    const listItem = addressList.children[i];
                    const addressNameInput = listItem.querySelector('.address-name');
                    if (!addressNameInput.value.trim() || listItem.dataset.id) continue;

                    try {
                        const response = await fetch(`https://geocode-maps.yandex.ru/1.x/?apikey=${apiKey}&format=json&geocode=${encodeURIComponent(addressNameInput.value)}`);
                        const data = await response.json();

                        if (data.response.GeoObjectCollection.metaDataProperty.GeocoderResponseMetaData.found > 0) {
                            const geoObject = data.response.GeoObjectCollection.featureMember[0].GeoObject;
                            const point = geoObject.Point.pos.split(' ');
                            const latitude = parseFloat(point[1]);
                            const longitude = parseFloat(point[0]);

                            newAddresses.push({
                                name: addressNameInput.value.trim(),
                                latitude: latitude.toFixed(6),
                                longitude: longitude.toFixed(6)
                            });
                        }
                    } catch (error) {
                        console.error('Ошибка при получении координат:', error);
                    }
                }

                if (newAddresses.length > 0) {
                    fetch("{% url 'add_new_addresses' event.id %}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({
                            new_addresses: newAddresses
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'ok') {
                            alert('Адреса успешно обновлены');
                            location.reload();
                        } else {
                            alert(data.message || 'Произошла ошибка при обновлении адресов');
                        }
                    })
                    .catch(error => {
                        console.error('Ошибка:', error);
                        alert('Ошибка сети');
                    });
                }
            };

            // Функция для проверки валидности API Key
            async function checkApiKeyValidity(apiKey) {
                try {
                    const response = await fetch(`https://geocode-maps.yandex.ru/1.x/?apikey=${apiKey}&format=json&geocode=test`);
                    if (!response.ok) {
                        return false;
                    }
                    const data = await response.json();
                    return (data && !data.error);
                } catch (error) {
                    console.error('Ошибка проверки API Key:', error);
                    return false;
                }
            }

            // Глобальная переменная для карты
            var map;

            // Глобальная функция для инициализации и обновления карты
            function initMap() {
                if (!map) {
                    map = new ymaps.Map('map', {
                        center: [55.76, 37.64],
                        zoom: 10
                    });
                }

                map.geoObjects.removeAll();

                let coordinates = [];

                $('#modal-event-addresses-list li').each(function() {
                    var latitudeText = $(this).find('.latitude').text().trim();
                    var longitudeText = $(this).find('.longitude').text().trim();
                    var name = $(this).find('.address-name').val() || '';
                    var addressNumber = $(this).find('.address-number').text().trim().replace('.', '');

                    var latitude = parseFloat(latitudeText.replace(',', '.'));
                    var longitude = parseFloat(longitudeText.replace(',', '.'));

                    if (!isNaN(latitude) && !isNaN(longitude)) {
                        var placemark = new ymaps.Placemark(
                            [latitude, longitude], 
                            {
                                balloonContent: `<strong>Адрес ${addressNumber}</strong>: ${name}`,
                                iconContent: addressNumber
                            }, 
                            {
                                preset: 'islands#redStretchyIcon'
                            }
                        );

                        map.geoObjects.add(placemark);
                        coordinates.push([latitude, longitude]);
                    } else {
                        console.warn('Некорректные координаты для адреса:', name);
                    }
                });

                if (coordinates.length > 1) {
                    var polyline = new ymaps.Polyline(coordinates, {}, {
                        strokeColor: '#0000FF',
                        strokeWidth: 3,
                        strokeOpacity: 0.5
                    });

                    map.geoObjects.add(polyline);
                }
            }

            let isOrderChanged = false; // Флаг для отслеживания изменений порядка

            function initializeSorting(selector) {
                $(selector).sortable({
                    placeholder: 'ui-state-highlight',
                    update: function(event, ui) {
                        updateAddressNumbersAfterSort(selector);
                        saveNewOrder(selector);

                        // Обновляем карту и устанавливаем флаг при изменении в модальном списке
                        if (selector === '#modal-event-addresses-list') {
                            ymaps.ready(initMap);
                            isOrderChanged = true; // Устанавливаем флаг изменения
                        }
                    }
                });

                $(selector).disableSelection();
            }

            function updateAddressNumbersAfterSort(selector) {
                $(selector + ' li').each(function(index) {
                    $(this).find('.address-number').text((index + 1) + '.');
                });
            }

            function saveNewOrder(selector) {
                const orderData = [];
                $(selector + ' li').each(function(index) {
                    const addressId = $(this).data('id');
                    orderData.push({ id: addressId, order: index });
                });

                $.ajax({
                    url: "{% url 'update_address_order' %}",
                    type: "POST",
                    data: {
                        order: JSON.stringify(orderData),
                        model: 'EventAddress',
                        csrfmiddlewaretoken: "{{ csrf_token }}"
                    },
                    success: function(response) {
                        console.log('Порядок адресов события успешно сохранен.');
                    },
                    error: function(response) {
                        console.error('Ошибка при сохранении порядка адресов события');
                    }
                });
            }

            // Инициализация сортировки
            initializeSorting('#event-addresses-list');
            initializeSorting('#modal-event-addresses-list');

            // Открытие модального окна и обновление меток
            $('#show-map-btn').click(function() {
                // Проверка на наличие адресов
                if ($('#modal-event-addresses-list li').length === 0 || $('#modal-event-addresses-list li:contains("Нет адресов.")').length > 0) {
                    alert("Нет доступных адресов для отображения.");
                    return;
                }

                // Проверка на наличие API Key
                const apiKey = "{{ user.profile.api_key }}"; // Предполагаем, что API Key передан в контекст
                if (!apiKey) {
                    alert("Вам нужно заполнить поле API Key в профиле.");
                    return;
                }

                // Показ карты
                $('#map-modal').show();
                ymaps.ready(initMap);
            });

            // Закрытие модального окна
            $('.modal .close').click(function() {
                $('#map-modal').hide();
                if (isOrderChanged) {
                    location.reload(); // Перезагрузка страницы, если изменился порядок
                }
            });


            // Открытие и закрытие модального окна
            $('#select-executors-btn').click(function() {
                // Собираем ID исполнителей, уже добавленных в список
                var existingExecutorIds = [];
                $('#event-executors-list li').each(function() {
                    existingExecutorIds.push($(this).data('id'));
                });

                // Находим чекбоксы, которые соответствуют существующим исполнителям, и блокируем их
                $('#executor-selection-list input[type=checkbox]').each(function() {
                    var executorId = $(this).data('id');
                    if (existingExecutorIds.includes(executorId)) {
                        $(this).prop('disabled', true);    // Отключаем чекбокс
                        $(this).prop('checked', true);     // Отмечаем чекбокс
                    } else {
                        $(this).prop('disabled', false);
                        $(this).prop('checked', false);    // Убираем отметку с чекбокса
                    }
                });

                $('#executor-modal').show();
            });
            $('.close').click(function() {
                $('#executor-modal').hide();
            });

            // AJAX-запрос для сохранения выбранных исполнителей
            $('#add-executors-btn').click(function() {
                var selectedExecutors = [];
                $('#executor-selection-list input:checked').each(function() {
                    selectedExecutors.push($(this).data('id'));
                });

                // Собираем уже существующие элементы из DOM
                $('#event-executors-list li').each(function() {
                    var executorId = $(this).data('id');
                    if (!selectedExecutors.includes(executorId)) {
                        selectedExecutors.push(executorId);
                    }
                });

                $.ajax({
                    url: "{% url 'update_event_executors' event.id %}",
                    type: "POST",
                    headers: {'X-CSRFToken': '{{ csrf_token }}'},
                    data: {
                        'executors': selectedExecutors
                    },
                    success: function(response) {
                        $('#executor-modal').hide();
                        // Обновите список исполнителей на странице
                        $('#event-executors-list').empty();
                        $.each(response.executors, function(index, executor) {
                            $('#event-executors-list').append(
                                `<li data-id="${executor.id}">
                                    <span class="user-name">${executor.name}</span>
                                    | <span class="district">${executor.district}</span>
                                    | <span class="phone-number">${executor.phone_number}</span>
                                    <button class="assign-btn" data-id="${executor.id}">Назначить</button>
                                    <button class="delete-executor-btn" data-id="${executor.id}">Удалить</button>
                                </li>`
                            );
                        });
                        location.reload();
                    },
                    error: function(xhr, status, error) {
                        alert('Ошибка при сохранении исполнителей. Попробуйте еще раз.');
                    }
                });
            });

            // Удаление исполнителя из списка
            $(document).on('click', '.delete-executor-btn', function() {
                var $executorItem = $(this).closest('li');
                var executorId = $executorItem.data('id');
                var executorStatus = $executorItem.data('status');
                var eventId = "{{ event.id }}";  // Замените на динамические данные, если требуется

                var confirmationMessage;
                switch (executorStatus) {
                    case 'confirmed':
                        confirmationMessage = "Вы действительно хотите удалить исполнителя, который подтвердил готовность выполнения назначенных адресов?";
                        break;
                    case 'in_progress':
                        confirmationMessage = "Вы действительно хотите удалить исполнителя, который начал выполнение назначенных адресов? Будут потеряны имеющиеся фотографии от данного исполнителя к данному событию!";
                        break;
                    case 'completed':
                        confirmationMessage = "Вы действительно хотите удалить исполнителя, который завершил выполнение назначенных адресов? Будут потеряны все фотографии от данного исполнителя к данному событию!";
                        break;
                    default:
                        confirmationMessage = null;
                }

                if (confirmationMessage) {
                    if (!confirm(confirmationMessage)) {
                        return; // Если пользователь отменил подтверждение, ничего не делаем
                    }
                }

                // Удаляем элемент из списка на странице
                $executorItem.remove();

                // Отправляем запрос на сервер для удаления
                $.ajax({
                    url: "{% url 'remove_executor' %}",
                    method: "POST",
                    data: {
                        'executor_id': executorId,
                        'event_id': eventId,
                        'csrfmiddlewaretoken': '{{ csrf_token }}'
                    },
                    success: function(response) {
                        console.log('Исполнитель удален');
                        location.reload();
                    },
                    error: function(xhr, status, error) {
                        console.error('Произошла ошибка при удалении исполнителя: ', error);
                    }
                });
            });

            // функция для преобразования ввода в список индексов
            function parseAddressIndexes(input) {
                let indexes = [];
                let parts = input.split(',');

                parts.forEach(part => {
                    if (part.includes('-')) {
                        let range = part.split('-').map(Number);
                        if (range.length === 2 && !isNaN(range[0]) && !isNaN(range[1])) {
                            if (range[0] <= range[1]) {
                                for (let i = range[0]; i <= range[1]; i++) {
                                    indexes.push(i);
                                }
                            }
                        }
                    } else if (!isNaN(part)) {
                        indexes.push(Number(part));
                    }
                });

                return indexes;
            }
            
            // Это для логики назначения исполнителя к события
            $('.assign-btn').click(function(){
                var userId = $(this).data('id');
                var eventId = "{{ event.id }}";

                var addressIndexes = [];
                if ($('#address-indexes-' + userId).length) {
                    var input = $('#address-indexes-' + userId).val();
                    addressIndexes = parseAddressIndexes(input);
                }

                $.ajax({
                    url: "{% url 'assign_executor' %}",
                    type: "POST",
                    data: {
                        'user_id': userId,
                        'event_id': eventId,
                        'address_indexes': JSON.stringify(addressIndexes),
                        'csrfmiddlewaretoken': '{{ csrf_token }}'
                    },
                    success: function(data) {
                        if(data.success) {
                            location.reload(); 
                        }
                    }
                });
            });
        });
    </script>
</body>
</html>