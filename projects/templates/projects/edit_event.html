<!-- templates/projects/edit_event.html -->
<!DOCTYPE html>
<html lang="ru_RU">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Правка события</title>
    {% load static %}
    <link rel="stylesheet" type="text/css" href="{% static 'css/normalize.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/styles.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/edit-event.css' %}">

    <script src="{% static 'js/jquery-3.7.1.min.js' %}"></script>
    <script src="https://api-maps.yandex.ru/2.1/?apikey={{ api_key }}&lang=ru_RU" type="text/javascript"></script>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="//code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
</head>
<div id="map-modal" class="modal">
    <div class="modal__content">
        <div class="modal__content-header">
            <h2 class="modal__title">{{ event.get_event_type_display }}: {{ project.name }}</h2>
            <span class="modal-close-btn"></span>
        </div>
        <div class="modal__content-wrap">
            <ul class="modal__event-addresses-list" id="modal-event-addresses-list">
                {% for address in event.addresses.all %}
                <li class="modal__event-addresses-item" data-id="{{ address.id }}">
                    <span class="address-number">={{ forloop.counter }}=</span> 
                    <span class="address-name" data-id="{{ address.id }}">{{ address.name }}</span>
                    <span class="hidden-coordinates">
                        <span class="latitude">{{ address.latitude }}</span> | 
                        <span class="longitude">{{ address.longitude }}</span>
                    </span>
                    {% if address.assigned_user %}
                        {% with address.assigned_user.executorprofile as profile %}
                            <span class="executor-name">{{ profile.name|default:address.assigned_user.username }}</span>
                        {% endwith %}
                    {% else %}
                        <span class="executor-name">Не назначен</span>
                    {% endif %}
                </li>
                {% empty %}
                <li>Нет адресов.</li>
                {% endfor %}
            </ul>
            <div class="map-wrap">
                <div id="map-modal-content" style="width: 100%; height: 100%;"></div>
            </div>
        </div>
    </div>
</div>
<body class="page event">
    <header class="page__header">
        <nav class="nav">
            <ul class="nav__list">
                <li class="nav__item">
                    <a class="nav__link nav__link--inactive" href="{% url 'profile' %}">Профиль</a>
                </li>
                <li class="nav__item">
                    <a class="nav__link nav__link--active">Проекты</a>
                </li>
                <li class="nav__item">
                    <a class="nav__link nav__link--inactive" href="{% url 'events_control' %}">Контроль</a>
                </li>
            </ul>
        </nav>
        <div class="logo">
            <img class="logo__img" src="{% static 'img/logo.png' %}" alt="Логотип">
        </div>
    </header>
    <div class="container">
        <div class="event__header">
            <h1 class="page__title">{{ event.get_event_type_display }}</h1>
            <ul class="bread-crumbs">
                <li class="bread-crumbs__item">
                    <a class="bread-crumbs__link" href="{% url 'edit_project' project.id %}">{{ project.name }}</a>
                </li>
                <li class="bread-crumbs__item">
                    <a class="bread-crumbs__link" href="{% url 'manage_projects' %}">Проекты</a>
                </li>
            </ul>
            <button class="event__save-btn btn" type="button" id="save-event-button">Сохранить событие</button>
            <a class="event__close-btn page__close-btn" href="{% url 'edit_project' project.id %}"></a>
        </div>
        <div class="event__content">
            <div class="event__content-row">
                <div class="event__content-col">
                    <div class="event__content-col-wrap">
                        <div class="event__content-cell" data-section-id="details">
                            <div class="event__cell-header" data-section-id="details">
                                <h2 class="page__block-title">Детали</h2>
                            </div>
                            <div class="event__cell-content" data-section-id="details">
                                <div class="event__cell-content-wrap">
                                    <form class="event__form" id="event-form" method="POST">
                                        {% csrf_token %}
                                        <div class="event__form-field">
                                            <label for="id_event_type">Событие</label>
                                            {{ form.event_type }}
                                        </div>
    
                                        <div class="event__form-field">
                                            <label for="id_photo_count">Кол-во фото</label>
                                            {{ form.photo_count }}
                                        </div>
    
                                        <div class="event__form-field">
                                            <label for="id_event_date">Дата начала</label>
                                            <div class="event__form-field-wrap">
                                                {{ form.event_date }}
                                            </div>
                                        </div>
                                
                                        <div class="event__form-field">
                                            <label for="id_duration_days">Срок выполнения (в днях)</label>
                                            {{ form.duration_days }}
                                        </div>
                                
                                        <div class="event__form-field">
                                            <label for="id_description">Описание</label>
                                            {{ form.description }}
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="event__content-cell" data-section-id="executors">
                            <div class="event__cell-header" data-section-id="executors">
                                <h2 class="page__block-title">Исполнители</h2>
                            </div>
                            <div class="event__cell-content" data-section-id="executors">
                                <div class="event__cell-content-wrap">
                                    <ul class="event__executors-list" id="event-executors-list">
                                        {% for event_user, has_photos in executors_with_photo_status %}
                                            {% if event_user.user.executorprofile %}
                                            <li class="event__executors-item" data-id="{{ event_user.user.id }}" data-status="{{ event_user.status }}">
                                                <div class="event__executors-item-row">
                                                    <span class="user-name">{{ event_user.user.executorprofile.name|default:event_user.user.email }}</span>
                                                    {% if event_user.user.executorprofile.district %}
                                                    <span class="district">{{ event_user.user.executorprofile.district }}</span>
                                                    {% endif %}
                                                    {% if event_user.user.executorprofile.phone_number %}
                                                    <span class="phone-number">{{ event_user.user.executorprofile.phone_number }}</span>
                                                    {% endif %}
                                                    <span class="status">{{ event_user.get_status_display }}</span>
                                                </div>
                                                <div class="event__executors-item-row">
                                                    {% if has_unassigned_addresses %}
                                                        <!-- <label for="address-indexes-{{ event_user.user.id }}">Адреса</label> -->
                                                        <input type="text" id="address-indexes-{{ event_user.user.id }}" placeholder="Пример: 1,3-5,10-20,25">
                                                        <button class="assign-btn btn" data-id="{{ event_user.user.id }}">Назначить</button>
                                                    {% endif %}
                                                </div>
                                                <div class="event__executors-item-row">
                                                    {% if has_photos %}
                                                        <button class="details-btn btn" data-id="{{ event_user.user.id }}">Показать фото</button>
                                                    {% endif %}
                                                    {% if event_user.status == 'completed' %}
                                                        <button class="download-photos-btn btn" data-id="{{ event_user.user.id }}">Скачать фото</button>
                                                    {% endif %}
                                                    {% if event_user.status != 'completed' %}
                                                        <button class="delete-executor-btn btn" data-id="{{ event_user.user.id }}">Удалить</button>
                                                    {% endif %}
                                                </div>
                                            </li>
                                            {% else %}
                                                <li class="event__executors-item event__executors-item--no-profile">У пользователя нет профиля исполнителя.</li>
                                            {% endif %}
                                        {% empty %}
                                            <li class="event__executors-item event__executors-item--no-executors">Нет исполнителей.</li>
                                        {% endfor %}
                                    </ul>
                                    <button class="select-executors-btn btn" type="button" id="select-executors-btn">Добавить</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="event__content-col">
                    <div class="event__content-col-wrap">
                        <div class="event__content-cell">
                            <ul class="tabs tabs__list">
                                <li class="tab tabs-item">
                                    <a class="tab-link active" id="active-tab" href="#event-addresses">Адреса</a>
                                </li>
                                <li class="tab tabs-item">
                                    <a class="tab-link" id="completed-tab" href="#event-map">Карта</a>
                                </li>
                                <button class="event__show-addresses-map-btn" type="button" id="show-map-btn"></button>
                            </ul>
                            <div class="tab-content">
                                <div class="event__addresses active" id="event-addresses">
                                    <h2 class="hidden-title">Адреса события</h2>
                                    <div class="event__addresses-header">
                                        <button class="copy-addresses-btn btn" type="button" id="copy-addresses-btn">Получить адреса проекта</button>
                                        <span class="remaining-requests" id="remaining-requests">{{ remaining_requests }}</span>
                                    </div>
                                    <ul class="event__addresses-list" id="event-addresses-list">
                                        {% for address in event.addresses.all %}
                                        <li class="event__addresses-item" data-id="{{ address.id }}" data-user-assigned="{% if address.assigned_user %}true{% else %}false{% endif %}">
                                            <span class="address-number">={{ forloop.counter }}=</span> 
                                            <span class="address-name" data-id="{{ address.id }}">{{ address.name }}</span>
                                            <span class="hidden-coordinates">
                                                <span class="latitude">{{ address.latitude }}</span> | 
                                                <span class="longitude">{{ address.longitude }}</span>
                                            </span>
                                            {% if address.assigned_user %}
                                                {% with address.assigned_user.executorprofile as profile %}
                                                    <span class="executor-name">{{ profile.name|default:address.assigned_user.username }}</span>
                                                {% endwith %}
                                            {% else %}
                                                <span class="executor-name">Не назначен</span>
                                            {% endif %}
                                            <button class="delete-address-btn btn" data-id="{{ address.id }}">Удалить</button>
                                        </li>
                                        {% empty %}
                                        <li>Нет адресов.</li>
                                        {% endfor %}
                                    </ul>
                                    <div class="event__addresses-btns">
                                        <button class="add-address-btn btn" type="button" id="add-address-btn">Добавить адрес</button>
                                        <button class="update-addresses-btn btn" type="button" id="update-addresses-btn">Обновить список</button>
                                    </div>
                                    <!-- <button type="button" id="show-map-btn">Показать карту</button> -->
                                </div>
                                <div class="event__map" id="event-map">
                                    <h2 class="hidden-title">Карта события</h2>
                                    <div id="map-event" style="width: 100%; height: 100%;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        
            <!-- Модальное окно для выбора исполнителей -->
            <div id="executor-modal" class="modal">
                <div class="modal-content">
                    <span class="close">&times;</span>
                    <h3>Выберите исполнителей</h3>
                    <ul id="executor-selection-list">
                        {% for user in executors %}
                            {% with user.executorprofile as profile %}
                            <li>
                                <input type="checkbox" id="executor-{{ profile.user.id }}" data-id="{{ profile.user.id }}" data-name="{{ profile.name|default:user.email }}">
                                <label for="executor-{{ profile.user.id }}">
                                    <span class="user-name">{{ profile.name|default:user.email }}</span>
                                    {% if profile.district %} | <span class="district">{{ profile.district }}</span>{% endif %}
                                    {% if profile.phone_number %} | <span class="phone-number">{{ profile.phone_number }}</span>{% endif %}
                                </label>
                            </li>
                            {% endwith %}
                        {% endfor %}
                    </ul>
                    <button type="button" id="add-executors-btn">Выбрать</button>
                </div>
            </div>
        
            <!-- <div id="map-modal" class="modal">
                <div class="modal-content">
                    <span class="close">&times;</span>
                    <div id="map-modal-content" style="width: 600px; height: 400px;"></div>
                    <ul id="modal-event-addresses-list">
                        {% for address in event.addresses.all %}
                        <li data-id="{{ address.id }}">
                            <span class="address-number">{{ forloop.counter }}.</span> 
                            <span class="address-name" data-id="{{ address.id }}">{{ address.name }}</span>
                            <span class="hidden-coordinates">
                                <span class="latitude">{{ address.latitude }}</span> | 
                                <span class="longitude">{{ address.longitude }}</span>
                            </span>
                        </li>
                        {% empty %}
                        <li>Нет адресов.</li>
                        {% endfor %}
                    </ul>
                </div>
            </div> -->
        
            <div id="photo-gallery-modal" class="modal">
                <div class="modal-content">
                    <span class="close">&times;</span>
                    <h2>Фото Галерея</h2>
                    <div id="gallery-content" class="photo-gallery">
                        <!-- Основная галерея будет загружаться тут -->
                    </div>
                    <h3>Проблемные Фото</h3>
                    <div id="problems-gallery-content" class="photo-gallery" style="display: none;">
                        <!-- Проблемные фото будут загружаться сюда -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const tabLinks = document.querySelectorAll(".tab-link");
            const tabPanes = document.querySelectorAll(".tab-content > div");

            tabLinks.forEach(link => {
                link.addEventListener("click", function(e) {
                    e.preventDefault();

                    // Удаляем класс 'active' у всех ссылок и содержимого
                    tabLinks.forEach(item => item.classList.remove('active'));
                    tabPanes.forEach(pane => pane.classList.remove('active'));

                    // Добавляем класс 'active' для текущей ссылки и её содержимого
                    this.classList.add('active');
                    const targetId = this.getAttribute('href').substring(1);
                    const targetPane = document.getElementById(targetId);
                    targetPane.classList.add('active');
                });
            });
        });

        // Инициализация аккордеона
        $('.event__content-cell').each(function () {
            const sectionId = $(this).data('section-id');
            let isOpen = localStorage.getItem(`accordion-${sectionId}`) === 'true';
            $(this).find('.event__cell-content').toggle(isOpen);
            $(this).find('.event__cell-header').toggleClass('event__cell-header--active', isOpen);
        });

        $('.event__cell-header').on('click', function () {
            const section = $(this).closest('.event__content-cell');
            const sectionId = section.data('section-id');
            $(this).next('.event__cell-content').slideToggle(function () {
                const isOpen = $(this).is(':visible');
                localStorage.setItem(`accordion-${sectionId}`, isOpen.toString());
            });
            $(this).toggleClass('event__cell-header--active');
        });

        // фотогалерея
        $(document).ready(function() {
            $('.details-btn').click(function() {
                const userId = $(this).data('id');
                const eventId = "{{ event.id }}";

                $.ajax({
                    url: "{% url 'fetch_executor_photos' %}",
                    type: "GET",
                    data: {
                        'user_id': userId,
                        'event_id': eventId
                    },
                    success: function(data) {
                        console.log(data); // Добавьте эту строку для отладки

                        const galleryContent = $('#gallery-content');
                        const problemsGalleryContent = $('#problems-gallery-content');

                        galleryContent.empty();
                        problemsGalleryContent.empty();

                        data.photos.forEach(photo => {
                            const img = $('<img>').attr('src', photo.url).attr('alt', photo.name);
                            img.click(function() {
                                openPhotoModal(photo.url);
                            });
                            galleryContent.append($('<div>').append(img).append($('<span>').text(photo.name)));
                        });

                        if (data.problems && data.problems.length > 0) {
                            problemsGalleryContent.show();
                            data.problems.forEach(photo => {
                                const img = $('<img>').attr('src', photo.url).attr('alt', photo.name);
                                img.click(function() {
                                    openPhotoModal(photo.url);
                                });
                                problemsGalleryContent.append($('<div>').append(img).append($('<span>').text(photo.name)));
                            });
                        } else {
                            problemsGalleryContent.hide();
                        }

                        $('#photo-gallery-modal').fadeIn();
                    },
                    error: function(error) {
                        alert('Не удалось загрузить фотографии');
                    }
                });
            });

            // Закрытие галереи при нажатии на кнопку закрытия
            $('#photo-gallery-modal .close').click(function() {
                $('#photo-gallery-modal').fadeOut();
            });

            // Закрытие галереи при нажатии вне его контента
            $('#photo-gallery-modal').click(function(event) {
                if ($(event.target).is('#photo-gallery-modal')) {
                    $(this).fadeOut();
                }
            });

            function openPhotoModal(photoUrl) {
                const modalOverlay = $('<div>').addClass('photo-view-modal');

                const img = $('<img>').attr('src', photoUrl);
                const closeBtn = $('<span>').addClass('close-photo').text('×').click(function() {
                    modalOverlay.fadeOut(() => modalOverlay.remove());
                });

                modalOverlay.append(closeBtn).append(img);

                // Закрытие увеличенного фото при нажатии на фон
                modalOverlay.click(function(event) {
                    if ($(event.target).is('.photo-view-modal')) {
                        modalOverlay.fadeOut(() => modalOverlay.remove());
                    }
                });

                $('body').append(modalOverlay);
            }

            // Обработчик для кнопки скачивания в списке исполнителей
            $('.download-photos-btn').click(function() {
                const userId = $(this).data('id');
                const eventId = "{{ event.id }}";
                const downloadUrl = "{% url 'download_executor_photos' %}";

                // Отправка запроса на сервер для создания и получения архива
                window.location.href = `${downloadUrl}?user_id=${userId}&event_id=${eventId}`;
            });
        });
        // обновление счётчика запросов
        function updateRemainingRequests() {
            fetch('{% url "get_remaining_requests" %}', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}', // Если включена защита CSRF
                },
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('remaining-requests').innerText = `${data.remaining_requests}`;
            })
            .catch(error => console.error('Ошибка при обновлении оставшихся запросов:', error));
        }

        // Запрашиваем сервер каждый час, чтобы обновить данные
        setInterval(updateRemainingRequests, 60 * 60 * 1000);  // Каждые 60 минут

        // Проверяем время до полуночи и запускаем обновление в полночь
        const timeUntilMidnight = '{{ seconds_until_midnight }}';
        setTimeout(updateRemainingRequests, timeUntilMidnight * 1000);
        $(document).ready(function() {
            // сохранение события
            $('#save-event-button').click(function() {
                $('#event-form').submit();
            });
            // Функция для проверки статусов исполнителей
            function checkExecutorsStatus() {
                let allowCopy = true; // По умолчанию разрешаем копирование адресов

                // Проходим по каждому исполнителю
                $('#event-executors-list li').each(function() {
                    const statusText = $(this).find('.status').text().trim();
                    
                    // Проверяем, содержит ли статус запрещенные значения
                    if (statusText.includes('Назначено') || 
                        statusText.includes('Подтверждено') || 
                        statusText.includes('Отказ') || 
                        statusText.includes('В работе') || 
                        statusText.includes('Завершено')) {
                        allowCopy = false;
                        return false; // Выходим из цикла, так как копирование уже запрещено
                    }
                });

                // Устанавливаем кнопку активной или неактивной в зависимости от условия
                $('#copy-addresses-btn').prop('disabled', !allowCopy);
            }

            // Изначально проверяем статусы при загрузке страницы
            checkExecutorsStatus();
            // Синхронизация адресов с проекта
            $('#copy-addresses-btn').click(function() {
                const eventId = "{{ event.id }}";  // Получаем ID текущего события
                $.ajax({
                    url: "{% url 'copy_addresses' event.id %}",  // URL, на который будет отправлен POST-запрос
                    type: "POST",
                    data: {
                        csrfmiddlewaretoken: "{{ csrf_token }}",
                    },
                    success: function(response) {
                        alert('Адреса были успешно добавлены');
                        location.reload(); // Перезагружаем страницу
                    },
                    error: function(response) {
                        if (response.responseJSON && response.responseJSON.error) {
                            alert(response.responseJSON.error);
                        } else {
                            alert('Произошла ошибка при добавлении адресов');
                        }
                    }
                });
            });
            // Обработка удаления конкретного адреса
            $('#event-addresses-list').on('click', '.delete-address-btn', function() {
                const listItem = $(this).closest('li');
                const addressId = listItem.data('id');
                const isUserAssigned = listItem.attr('data-user-assigned') === 'true'; // Используйте attr, если data возвращает unexpected results

                // Добавьте отладочный вывод
                console.log('Удаление адреса: ', addressId);
                console.log('Назначен исполнитель:', isUserAssigned);

                if (isUserAssigned) {
                    const confirmationMessage = "Вы действительно хотите удалить адрес, который назначен исполнителю? Будут удалены имеющиеся фото к этому адресу!";
                    
                    // Еще один отладочный вывод для подтверждения
                    console.log('Отображаем подтверждение');
                    
                    if (!confirm(confirmationMessage)) {
                        console.log('Удаление отменено');
                        return; // Если пользователь отменил подтверждение, ничего не делаем
                    }
                }

                // Если дошли до сюда, значит, пользователь подтвердил или подтверждение не требовалось
                $.ajax({
                    url: "{% url 'delete_event_address' 0 %}".replace('/0/', '/' + addressId + '/'),
                    type: "POST",
                    data: {
                        csrfmiddlewaretoken: "{{ csrf_token }}",
                    },
                    success: function(response) {
                        listItem.remove();  // Удаляем элемент из DOM после успешного удаления из БД
                        updateAddressNumbers(); // Обновляем нумерацию оставшихся адресов
                    },
                    error: function(response) {
                        alert('Произошла ошибка при удалении адреса');
                    }
                });
            });

            document.getElementById('add-address-btn').onclick = function() {
                const addressList = document.getElementById('event-addresses-list');
                
                // Создаем новый элемент списка без данных
                const newListItem = document.createElement('li');
                newListItem.innerHTML = `
                    <span class="address-number">=${addressList.children.length + 1}=</span>
                    <input type="text" name="new_address_names[]" class="address-name" placeholder="Введите название адреса">
                    <span class="latitude"></span> | <span class="longitude"></span>
                    <button type="button" class="delete-address-btn">Удалить</button>
                `;
                
                addressList.appendChild(newListItem);
                updateAddressNumbers();
                
                newListItem.querySelector('.delete-address-btn').onclick = function() {
                    addressList.removeChild(newListItem);
                    updateAddressNumbers();
                };
            };

            // Функция для обновления нумерации адресов
            function updateAddressNumbers() {
                $('#event-addresses-list .address-number').each(function(index) {
                    $(this).text((index + 1) + '.');
                });
            }

            document.getElementById('update-addresses-btn').onclick = async function () {
                const apiKey = "{{ user.profile.api_key }}"; // Предполагаем, что API Key передан в контекст

                if (!apiKey) {
                    alert("Вам нужно заполнить поле API Key в профиле");
                    return;
                }

                let isValidApiKey = await checkApiKeyValidity(apiKey);
                if (!isValidApiKey) {
                    alert("Ваш API Key недействителен. Пожалуйста, проверьте его корректность.");
                    return;
                }

                const addressList = document.getElementById('event-addresses-list');
                const newAddresses = [];
                const listItemsToRemove = [];

                for (let i = 0; i < addressList.children.length; i++) {
                    const listItem = addressList.children[i];
                    const addressNameElement = listItem.querySelector('.address-name');
                    const addressName = addressNameElement instanceof HTMLInputElement ? addressNameElement.value : addressNameElement.textContent.trim();
                    
                    if (!addressName || listItem.dataset.id) continue;

                    try {
                        const response = await fetch(`https://geocode-maps.yandex.ru/1.x/?apikey=${apiKey}&format=json&geocode=${encodeURIComponent(addressName)}`);
                        const data = await response.json();

                        if (data.response.GeoObjectCollection.metaDataProperty.GeocoderResponseMetaData.found > 0) {
                            const geoObject = data.response.GeoObjectCollection.featureMember[0].GeoObject;
                            const point = geoObject.Point.pos.split(' ');
                            const latitude = parseFloat(point[1]);
                            const longitude = parseFloat(point[0]);

                            newAddresses.push({
                                name: addressName,
                                latitude: latitude.toFixed(6),
                                longitude: longitude.toFixed(6)
                            });

                            // Mark the list item for removal after successful addition
                            listItemsToRemove.push(listItem);
                        }
                    } catch (error) {
                        console.error('Ошибка при получении координат:', error);
                    }
                }

                if (newAddresses.length > 0) {
                    fetch("{% url 'add_new_addresses' event.id %}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({
                            new_addresses: newAddresses
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'ok') {
                            alert('Адреса успешно обновлены');
                            location.reload(); // Перезагружаем страницу
                        } else {
                            alert(data.message || 'Произошла ошибка при обновлении адресов');
                        }
                    })
                    .catch(error => {
                        console.error('Ошибка:', error);
                        alert('Ошибка сети');
                    });
                }
            };

            // Функция для проверки валидности API Key
            async function checkApiKeyValidity(apiKey) {
                try {
                    const response = await fetch(`https://geocode-maps.yandex.ru/1.x/?apikey=${apiKey}&format=json&geocode=test`);
                    if (!response.ok) {
                        return false;
                    }
                    const data = await response.json();
                    return (data && !data.error);
                } catch (error) {
                    console.error('Ошибка проверки API Key:', error);
                    return false;
                }
            }

            // Глобальная переменная для карты
            var map;

            // Глобальная функция для инициализации и обновления карты
            function initMap(containerId) {
                const map = new ymaps.Map(containerId, {
                    center: [55.76, 37.64],
                    zoom: 10
                });

                map.geoObjects.removeAll();

                let coordinates = [];

                $('#modal-event-addresses-list li').each(function() {
                    const latitudeText = $(this).find('.latitude').text().trim();
                    const longitudeText = $(this).find('.longitude').text().trim();
                    const name = $(this).find('.address-name').text().trim();
                    const addressNumber = $(this).find('.address-number').text().trim().replace('.', '');

                    const latitude = parseFloat(latitudeText.replace(',', '.'));
                    const longitude = parseFloat(longitudeText.replace(',', '.'));

                    if (!isNaN(latitude) && !isNaN(longitude)) {
                        const placemark = new ymaps.Placemark(
                            [latitude, longitude], 
                            {
                                balloonContent: `<strong>Адрес ${addressNumber}</strong>: ${name}`,
                                iconContent: addressNumber
                            }, 
                            {
                                preset: 'islands#redStretchyIcon'
                            }
                        );

                        map.geoObjects.add(placemark);
                        coordinates.push([latitude, longitude]);
                    } else {
                        console.warn('Некорректные координаты для адреса:', name);
                    }
                });

                if (coordinates.length > 1) {
                    const polyline = new ymaps.Polyline(coordinates, {}, {
                        strokeColor: '#0000FF',
                        strokeWidth: 3,
                        strokeOpacity: 0.5
                    });

                    map.geoObjects.add(polyline);
                }
            }

            ymaps.ready(function() {
                initMap('map-event'); // Инициализация карты в основном блоке
                initMap('map-modal-content'); // Инициализация карты в модальном окне
            });

            function updateMaps() {
                ymaps.ready(function() {
                    initMap('map-event');
                    initMap('map-modal-content');
                });
            }

            let isOrderChanged = false; // Флаг для отслеживания изменений порядка

            function initializeSorting(selector) {
                $(selector).sortable({
                    placeholder: 'ui-state-highlight',
                    update: function(event, ui) {
                        updateAddressNumbersAfterSort(selector);
                        saveNewOrder(selector);

                        // Обновляем карту и устанавливаем флаг при изменении в модальном списке
                        if (selector === '#modal-event-addresses-list') {
                            ymaps.ready(initMap);
                            isOrderChanged = true; // Устанавливаем флаг изменения
                        }
                    }
                });

                $(selector).disableSelection();
            }

            function updateAddressNumbersAfterSort(selector) {
                $(selector + ' li').each(function(index) {
                    $(this).find('.address-number').text((index + 1) + '.');
                });
            }

            function saveNewOrder(selector) {
                const orderData = [];
                $(selector + ' li').each(function(index) {
                    const addressId = $(this).data('id');
                    orderData.push({ id: addressId, order: index });
                });

                $.ajax({
                    url: "{% url 'update_address_order' %}",
                    type: "POST",
                    data: {
                        order: JSON.stringify(orderData),
                        model: 'EventAddress',
                        csrfmiddlewaretoken: "{{ csrf_token }}"
                    },
                    success: function(response) {
                        console.log('Порядок адресов события успешно сохранен.');
                    },
                    error: function(response) {
                        console.error('Ошибка при сохранении порядка адресов события');
                    }
                });
            }

            // Инициализация сортировки
            initializeSorting('#event-addresses-list');
            initializeSorting('#modal-event-addresses-list');

            // Открытие модального окна и обновление меток
            $('#show-map-btn').click(function() {
                // Проверка на наличие адресов
                if ($('#modal-event-addresses-list li').length === 0 || $('#modal-event-addresses-list li:contains("Нет адресов.")').length > 0) {
                    alert("Нет доступных адресов для отображения.");
                    return;
                }

                // Проверка на наличие API Key
                const apiKey = "{{ user.profile.api_key }}"; // Предполагаем, что API Key передан в контекст
                if (!apiKey) {
                    alert("Вам нужно заполнить поле API Key в профиле.");
                    return;
                }

                document.body.classList.add('no-scroll');

                // Показ карты
                $('#map-modal').show();
                ymaps.ready(initMap);
            });

            // Закрытие модального окна
            $('.modal .modal-close-btn').click(function() {
                $('#map-modal').hide();
                document.body.classList.remove('no-scroll');
                if (isOrderChanged) {
                    location.reload(); // Перезагрузка страницы, если изменился порядок
                }
            });


            // Открытие и закрытие модального окна
            $('#select-executors-btn').click(function() {
                // Собираем ID исполнителей, уже добавленных в список
                var existingExecutorIds = [];
                $('#event-executors-list li').each(function() {
                    existingExecutorIds.push($(this).data('id'));
                });

                // Находим чекбоксы, которые соответствуют существующим исполнителям, и блокируем их
                $('#executor-selection-list input[type=checkbox]').each(function() {
                    var executorId = $(this).data('id');
                    if (existingExecutorIds.includes(executorId)) {
                        $(this).prop('disabled', true);    // Отключаем чекбокс
                        $(this).prop('checked', true);     // Отмечаем чекбокс
                    } else {
                        $(this).prop('disabled', false);
                        $(this).prop('checked', false);    // Убираем отметку с чекбокса
                    }
                });

                $('#executor-modal').show();
            });
            $('.close').click(function() {
                $('#executor-modal').hide();
            });

            // AJAX-запрос для сохранения выбранных исполнителей
            $('#add-executors-btn').click(function() {
                var selectedExecutors = [];
                $('#executor-selection-list input:checked').each(function() {
                    selectedExecutors.push($(this).data('id'));
                });

                // Собираем уже существующие элементы из DOM
                $('#event-executors-list li').each(function() {
                    var executorId = $(this).data('id');
                    if (!selectedExecutors.includes(executorId)) {
                        selectedExecutors.push(executorId);
                    }
                });

                $.ajax({
                    url: "{% url 'update_event_executors' event.id %}",
                    type: "POST",
                    headers: {'X-CSRFToken': '{{ csrf_token }}'},
                    data: {
                        'executors': selectedExecutors
                    },
                    success: function(response) {
                        $('#executor-modal').hide();
                        // Обновите список исполнителей на странице
                        $('#event-executors-list').empty();
                        $.each(response.executors, function(index, executor) {
                            $('#event-executors-list').append(
                                `<li data-id="${executor.id}">
                                    <span class="user-name">${executor.name}</span>
                                    | <span class="district">${executor.district}</span>
                                    | <span class="phone-number">${executor.phone_number}</span>
                                    <button class="assign-btn" data-id="${executor.id}">Назначить</button>
                                    <button class="delete-executor-btn" data-id="${executor.id}">Удалить</button>
                                </li>`
                            );
                        });
                        location.reload();
                    },
                    error: function(xhr, status, error) {
                        alert('Ошибка при сохранении исполнителей. Попробуйте еще раз.');
                    }
                });
            });

            // Удаление исполнителя из списка
            $(document).on('click', '.delete-executor-btn', function() {
                var $executorItem = $(this).closest('li');
                var executorId = $executorItem.data('id');
                var executorStatus = $executorItem.data('status');
                var eventId = "{{ event.id }}";  // Замените на динамические данные, если требуется

                var confirmationMessage;
                switch (executorStatus) {
                    case 'confirmed':
                        confirmationMessage = "Вы действительно хотите удалить исполнителя, который подтвердил готовность выполнения назначенных адресов?";
                        break;
                    case 'in_progress':
                        confirmationMessage = "Вы действительно хотите удалить исполнителя, который начал выполнение назначенных адресов? Будут потеряны имеющиеся фотографии от данного исполнителя к данному событию!";
                        break;
                    case 'completed':
                        confirmationMessage = "Вы действительно хотите удалить исполнителя, который завершил выполнение назначенных адресов? Будут потеряны все фотографии от данного исполнителя к данному событию!";
                        break;
                    default:
                        confirmationMessage = null;
                }

                if (confirmationMessage) {
                    if (!confirm(confirmationMessage)) {
                        return; // Если пользователь отменил подтверждение, ничего не делаем
                    }
                }

                // Удаляем элемент из списка на странице
                $executorItem.remove();

                // Отправляем запрос на сервер для удаления
                $.ajax({
                    url: "{% url 'remove_executor' %}",
                    method: "POST",
                    data: {
                        'executor_id': executorId,
                        'event_id': eventId,
                        'csrfmiddlewaretoken': '{{ csrf_token }}'
                    },
                    success: function(response) {
                        console.log('Исполнитель удален');
                        location.reload();
                    },
                    error: function(xhr, status, error) {
                        console.error('Произошла ошибка при удалении исполнителя: ', error);
                    }
                });
            });

            // функция для преобразования ввода в список индексов
            function parseAddressIndexes(input) {
                let indexes = [];
                let parts = input.split(',');

                parts.forEach(part => {
                    if (part.includes('-')) {
                        let range = part.split('-').map(Number);
                        if (range.length === 2 && !isNaN(range[0]) && !isNaN(range[1])) {
                            if (range[0] <= range[1]) {
                                for (let i = range[0]; i <= range[1]; i++) {
                                    indexes.push(i);
                                }
                            }
                        }
                    } else if (!isNaN(part)) {
                        indexes.push(Number(part));
                    }
                });

                return indexes;
            }
            
            // Это для логики назначения исполнителя к события
            $('.assign-btn').click(function() {
                const userId = $(this).data('id');
                const eventId = '{{ event.id }}';
                const maxIndex = '{{ event.addresses.all|length }}';  // Используем адреса, непосредственно связанные с событием

                let addressIndexes = [];
                const inputElement = $('#address-indexes-' + userId);
                
                if (inputElement.length) {
                    const input = inputElement.val();
                    addressIndexes = parseAddressIndexes(input);
                }

                // Проверка диапазонов на валидность
                const isValid = addressIndexes.every(index => index >= 1 && index <= maxIndex);

                if (!isValid) {
                    alert(`Пожалуйста, введите номера в диапазоне от 1 до ${maxIndex}.`);
                    return;
                }

                $.ajax({
                    url: "{% url 'assign_executor' %}",
                    type: "POST",
                    data: {
                        'user_id': userId,
                        'event_id': eventId,
                        'address_indexes': JSON.stringify(addressIndexes),
                        'csrfmiddlewaretoken': '{{ csrf_token }}'
                    },
                    success: function(data) {
                        if (data.success) {
                            location.reload();
                        } else if (data.message) {
                            alert(data.message);  // Вывод ошибки
                        }
                    }
                });
            });
        });
    </script>
</body>
<footer class="page__footer">

</footer>
</html>