<!-- templates/projects/edit_event.html -->
<html>
<head>
    <title>Правка события - {{ event.get_event_type_display }}</title>
    {% load static %}
    <script src="{% static 'js/jquery-3.7.1.min.js' %}"></script>
    <link rel="stylesheet" type="text/css" href="{% static 'projects/yandex-map-modal.css' %}">
    <script src="https://api-maps.yandex.ru/2.1/?apikey=<212ad00a-2b33-4742-9805-36eb9352e2df>&lang=ru_RU" type="text/javascript"></script>
</head>
<body>
    <h1>Правка события: {{ event.get_event_type_display }} | {{ project.name }}</h1>
    <form method="POST">
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit">Сохранить</button>
    </form>
    <a href="{% url 'edit_project' project.id %}">Назад</a>
    
    <button type="button" id="copy-addresses-btn">Добавить адреса</button>
    
    <h2>Адреса для события</h2>
    <ul id="event-addresses-list">
        {% for address in event.addresses.all %}
        <li>
            <span>{{ forloop.counter }}. {{ address.name }} ({{ address.latitude }}, {{ address.longitude }})</span>
        </li>
        {% empty %}
        <li>Нет адресов.</li>
        {% endfor %}
    </ul>

    <button type="button" id="add-address-btn">Добавить адрес</button>
    <button type="button" id="update-addresses-btn">Обновить список</button>
    <button type="button" id="save-addresses-btn">Сохранить адреса</button>
    
    <div id="map-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div id="map" style="width: 600px; height: 400px;"></div>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            $('#copy-addresses-btn').click(function() {
                const eventId = "{{ event.id }}";  // Получаем ID текущего события
                $.ajax({
                    url: "{% url 'copy_addresses' event.id %}",  // URL, на который будет отправлен POST-запрос
                    type: "POST",
                    data: {
                        csrfmiddlewaretoken: "{{ csrf_token }}",
                    },
                    success: function(response) {
                        alert('Адреса были успешно добавлены');
                        
                        // Очистить текущий список адресов
                        $('#event-addresses-list').empty();
                        
                        // Перебрать полученные адреса и добавить их в список
                        response.addresses.forEach(function(address, index) {
                            $('#event-addresses-list').append('<li>' + (index + 1) + '. ' + address.name + ' (' + address.latitude + ', ' + address.longitude + ')</li>');
                        });
                    },
                    error: function(response) {
                        alert('Произошла ошибка при добавлении адресов');
                    }
                });
            });
        });
    </script>
</body>
</html>