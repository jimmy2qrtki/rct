<!-- templates/projects/edit_event.html -->
<!DOCTYPE html>
<html lang="ru_RU">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Правка события</title>
    {% load static %}
    <link rel="stylesheet" type="text/css" href="{% static 'css/normalize.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/styles.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/edit-event.css' %}">

    <script src="https://api-maps.yandex.ru/2.1/?apikey={{ api_key }}&lang=ru_RU" type="text/javascript"></script>
    <script src="{% static 'js/jquery-3.7.1.min.js' %}"></script>
    <script src="{% static 'js/jquery-ui.1.12.1.min.js' %}"></script>
    <script src="{% static 'js/edit_event.js' %}"></script>
</head>
<div id="map-modal" class="modal">
    <div class="modal__content">
        <div class="modal__content-header">
            <h2 class="modal__title">{{ event.get_event_type_display }}: {{ project.name }}</h2>
            <span class="modal-close-btn"></span>
        </div>
        <div class="modal__content-wrap">
            <ul class="modal__event-addresses-list" id="modal-event-addresses-list">
                {% for address in event.addresses.all %}
                <li class="modal__event-addresses-item" data-id="{{ address.id }}">
                    <span class="address-number">={{ forloop.counter }}=</span> 
                    <span class="address-name" data-id="{{ address.id }}">{{ address.name }}</span>
                    <span class="hidden-coordinates">
                        <span class="latitude">{{ address.latitude }}</span> | 
                        <span class="longitude">{{ address.longitude }}</span>
                    </span>
                    {% if address.assigned_user %}
                        {% with address.assigned_user.executorprofile as profile %}
                            <span class="executor-name">{{ profile.name|default:address.assigned_user.username }}</span>
                        {% endwith %}
                    {% else %}
                        <span class="executor-name">Не назначен</span>
                    {% endif %}
                </li>
                {% empty %}
                <li>Нет адресов.</li>
                {% endfor %}
            </ul>
            <div class="map-wrap">
                <div id="map-modal-content" style="width: 100%; height: 100%;"></div>
            </div>
        </div>
    </div>
</div>
<body class="page event">
    <header class="page__header">
        <nav class="nav">
            <ul class="nav__list">
                <li class="nav__item">
                    <a class="nav__link nav__link--inactive" href="{% url 'profile' %}">Профиль</a>
                </li>
                <li class="nav__item">
                    <a class="nav__link nav__link--active">Проекты</a>
                </li>
                <li class="nav__item">
                    <a class="nav__link nav__link--inactive" href="{% url 'events_control' %}">Контроль</a>
                </li>
            </ul>
        </nav>
        <div class="logo">
            <img class="logo__img" src="{% static 'img/logo.png' %}" alt="Логотип">
        </div>
    </header>
    <div class="container">
        <div class="event__header">
            <h1 class="page__title">{{ event.get_event_type_display }}</h1>
            <ul class="bread-crumbs">
                <li class="bread-crumbs__item">
                    <a class="bread-crumbs__link" href="{% url 'edit_project' project.id %}">{{ project.name }}</a>
                </li>
                <li class="bread-crumbs__item">
                    <a class="bread-crumbs__link" href="{% url 'manage_projects' %}">Проекты</a>
                </li>
            </ul>
            <button class="event__save-btn btn" type="button" id="save-event-button">Сохранить событие</button>
            <a class="event__close-btn page__close-btn" href="{% url 'edit_project' project.id %}"></a>
        </div>
        <div class="event__content">
            <div class="event__content-row">
                <div class="event__content-col">
                    <div class="event__content-col-wrap">
                        <div class="event__content-cell" data-section-id="details">
                            <div class="event__cell-header" data-section-id="details">
                                <h2 class="page__block-title">Детали</h2>
                            </div>
                            <div class="event__cell-content" data-section-id="details">
                                <div class="event__cell-content-wrap">
                                    <form class="event__form" id="event-form" method="POST">
                                        {% csrf_token %}
                                        <div class="event__form-field">
                                            <label for="id_event_type">Событие</label>
                                            {{ form.event_type }}
                                        </div>
    
                                        <div class="event__form-field">
                                            <label for="id_photo_count">Кол-во фото</label>
                                            {{ form.photo_count }}
                                        </div>
    
                                        <div class="event__form-field">
                                            <label>Дата начала</label>
                                            <div class="event__form-field-wrap">
                                                {{ form.event_date }}
                                            </div>
                                        </div>
                                
                                        <div class="event__form-field">
                                            <label for="id_duration_days">Срок выполнения (в днях)</label>
                                            {{ form.duration_days }}
                                        </div>
                                
                                        <div class="event__form-field">
                                            <label for="id_description">Описание</label>
                                            {{ form.description }}
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="event__content-cell" data-section-id="executors">
                            <div class="event__cell-header" data-section-id="executors">
                                <h2 class="page__block-title">Исполнители</h2>
                            </div>
                            <div class="event__cell-content" data-section-id="executors">
                                <div class="event__cell-content-wrap">
                                    <ul class="event__executors-list" id="event-executors-list">
                                        {% for event_user, has_photos in executors_with_photo_status %}
                                            {% if event_user.user.executorprofile %}
                                            <li class="event__executors-item" data-id="{{ event_user.user.id }}" data-status="{{ event_user.status }}">
                                                <div class="event__executors-item-row">
                                                    <span class="user-name">{{ event_user.user.executorprofile.name|default:event_user.user.email }}</span>
                                                    {% if event_user.user.executorprofile.district %}
                                                    <span class="district">{{ event_user.user.executorprofile.district }}</span>
                                                    {% endif %}
                                                    {% if event_user.user.executorprofile.phone_number %}
                                                    <span class="phone-number">{{ event_user.user.executorprofile.phone_number }}</span>
                                                    {% endif %}
                                                    <span class="status">{{ event_user.get_status_display }}</span>
                                                </div>
                                                <div class="event__executors-item-row">
                                                    {% if has_unassigned_addresses %}
                                                        <!-- <label for="address-indexes-{{ event_user.user.id }}">Адреса</label> -->
                                                        <input type="text" id="address-indexes-{{ event_user.user.id }}" placeholder="Пример: 1,3-5,10-20,25">
                                                        <button class="assign-btn btn" data-id="{{ event_user.user.id }}">Назначить</button>
                                                    {% endif %}
                                                </div>
                                                <div class="event__executors-item-row">
                                                    {% if has_photos %}
                                                        <button class="details-btn btn" data-id="{{ event_user.user.id }}">Показать фото</button>
                                                    {% endif %}
                                                    {% if event_user.status == 'completed' %}
                                                        <button class="download-photos-btn btn" data-id="{{ event_user.user.id }}">Скачать фото</button>
                                                    {% endif %}
                                                    {% if event_user.status != 'completed' %}
                                                        <button class="delete-executor-btn btn" data-id="{{ event_user.user.id }}">Удалить</button>
                                                    {% endif %}
                                                </div>
                                            </li>
                                            {% else %}
                                                <li class="event__executors-item event__executors-item--no-profile">У пользователя нет профиля исполнителя.</li>
                                            {% endif %}
                                        {% empty %}
                                            <li class="event__executors-item event__executors-item--no-executors">Нет исполнителей.</li>
                                        {% endfor %}
                                    </ul>
                                    <button class="select-executors-btn btn" type="button" id="select-executors-btn">Добавить</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="event__content-col">
                    <div class="event__content-col-wrap">
                        <div class="event__content-cell">
                            <ul class="tabs tabs__list">
                                <li class="tab tabs-item">
                                    <a class="tab-link active" id="active-tab" href="#event-addresses">Адреса</a>
                                </li>
                                <li class="tab tabs-item">
                                    <a class="tab-link" id="completed-tab" href="#event-map">Карта</a>
                                </li>
                                <button class="event__show-addresses-map-btn" type="button" id="show-map-btn"></button>
                            </ul>
                            <div class="tab-content">
                                <div class="event__addresses active" id="event-addresses">
                                    <h2 class="hidden-title">Адреса события</h2>
                                    <div class="event__addresses-header">
                                        <button class="copy-addresses-btn btn" type="button" id="copy-addresses-btn">Получить адреса проекта</button>
                                        <span class="remaining-requests" id="remaining-requests">{{ remaining_requests }}</span>
                                    </div>
                                    <ul class="event__addresses-list" id="event-addresses-list">
                                        {% for address in event.addresses.all %}
                                        <li class="event__addresses-item" data-id="{{ address.id }}" data-user-assigned="{% if address.assigned_user %}true{% else %}false{% endif %}">
                                            <span class="address-number">={{ forloop.counter }}=</span> 
                                            <span class="address-name" data-id="{{ address.id }}">{{ address.name }}</span>
                                            <span class="hidden-coordinates">
                                                <span class="latitude">{{ address.latitude }}</span> | 
                                                <span class="longitude">{{ address.longitude }}</span>
                                            </span>
                                            {% if address.assigned_user %}
                                                {% with address.assigned_user.executorprofile as profile %}
                                                    <span class="executor-name">{{ profile.name|default:address.assigned_user.username }}</span>
                                                {% endwith %}
                                            {% else %}
                                                <span class="executor-name">Не назначен</span>
                                            {% endif %}
                                            <button class="delete-address-btn btn" data-id="{{ address.id }}">Удалить</button>
                                        </li>
                                        {% empty %}
                                        <li>Нет адресов</li>
                                        {% endfor %}
                                    </ul>
                                    <div class="event__addresses-btns">
                                        <button class="add-address-btn btn" type="button" id="add-address-btn">Добавить адрес</button>
                                        <button class="update-addresses-btn btn" type="button" id="update-addresses-btn">Обновить список</button>
                                    </div>
                                    <!-- <button type="button" id="show-map-btn">Показать карту</button> -->
                                </div>
                                <div class="event__map" id="event-map">
                                    <h2 class="hidden-title">Карта события</h2>
                                    <div id="map-event" style="width: 100%; height: 100%;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        
            <!-- Модальное окно для выбора исполнителей -->
            <div id="executor-modal" class="executor-modal">
                <div class="executor-modal__content">
                    <div class="executor-modal__content-header">
                        <h3 class="modal__title">Исполнители</h3>
                        <span class="modal-close-btn"></span>
                    </div>
                    <ul class="executor-modal__selection-list" id="executor-selection-list">
                        {% for user in executors %}
                            {% with user.executorprofile as profile %}
                            <li class="executor-modal__selection-item">
                                <input type="checkbox" id="executor-{{ profile.user.id }}" data-id="{{ profile.user.id }}" data-name="{{ profile.name|default:user.email }}">
                                <label for="executor-{{ profile.user.id }}">
                                    <span class="user-name">{{ profile.name|default:user.email }}</span>
                                    {% if profile.district %} | <span class="district">{{ profile.district }}</span>{% endif %}
                                    {% if profile.phone_number %} | <span class="phone-number">{{ profile.phone_number }}</span>{% endif %}
                                </label>
                            </li>
                            {% endwith %}
                        {% endfor %}
                    </ul>
                    <button class="executor-modal__add-btn btn" type="button" id="add-executors-btn">Добавить</button>
                </div>
            </div>
        
            <div id="photo-gallery-modal" class="photo-modal">
                <div class="photo-modal__content">
                    <div class="photo-modal__content-header">
                        <h2 class="modal__title">Фото Галерея</h2>
                        <span class="modal-close-btn"></span>
                    </div>
                    <div class="photo-modal__content-wrap">
                        <div id="gallery-content" class="photo-gallery">
                            <!-- Основная галерея будет загружаться тут -->
                        </div>
                        <h3 class="photo-modal__title">Проблемные адреса</h3>
                        <div id="problems-gallery-content" class="photo-gallery" style="display: none;">
                            <!-- Проблемные фото будут загружаться сюда -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Передача данных из Django в JavaScript
        const eventData = {
            eventId: "{{ event.id }}",
            projectId: "{{ project.id }}",
            apiKey: "{{ user.profile.api_key }}",
            csrfToken: "{{ csrf_token }}",
            urls: {
                fetchExecutorPhotos: "{% url 'fetch_executor_photos' %}",
                downloadExecutorPhotos: "{% url 'download_executor_photos' %}",
                copyAddresses: "{% url 'copy_addresses' event.id %}",
                deleteEventAddress: "{% url 'delete_event_address' 0 %}",
                updateAddressOrder: "{% url 'update_address_order' %}",
                addNewAddresses: "{% url 'add_new_addresses' event.id %}",
                updateEventExecutors: "{% url 'update_event_executors' event.id %}",
                removeExecutor: "{% url 'remove_executor' %}",
                assignExecutor: "{% url 'assign_executor' %}",
                checkExecutorsAfterAddressDeletion: "{% url 'check_executors_after_address_deletion' event.id %}",
                getRemainingRequests: "{% url 'get_remaining_requests' %}",
            },
            remainingRequests: "{{ remaining_requests }}",
            secondsUntilMidnight: "{{ seconds_until_midnight }}",
            addressesCount: "{{ event.addresses.all|length }}",  // Передаем длину списка адресов
        };
    </script>
</body>
<footer class="page__footer">

</footer>
</html>