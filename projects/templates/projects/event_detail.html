<!-- templates/projects/event_detail.html -->
<html lang="ru_RU">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Детали события</title>
    {% load static %}
    <script src="{% static 'js/jquery-3.7.1.min.js' %}"></script>
    <script src="//code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://api-maps.yandex.ru/2.1/?apikey={{ api_key }}&lang=ru_RU" type="text/javascript"></script>
    <style>
        .hidden-coordinates {
            display: none;
        }
    </style>
</head>
<body>
    <h1>{{ event.get_event_type_display }}: {{ event.project.name }}</h1>
    <div>
        <p>Организация: {{ event.project.organization }}</p>
        <p>Продукт: {{ event.project.product }}</p>
        <p>Кол-во фото: {{ event.photo_count }}</p>
        <p>Дата начала: {{ event.event_date }}</p>
        <p>Срок выполнения (в днях): {{ event.duration_days }}</p>
        <p>Описание: {{ event.description }}</p>
    </div>

    <h3>Назначенные адреса</h3>
    <div id="map" style="width: 100%; height: 400px; margin-bottom: 20px;"></div>
    <button id="update-route">Обновить маршрут</button>
    <button id="print-addresses">Печать маршрута</button>
    <ul id="assigned-event-addresses-list">
        {% for item in addresses_with_photos %}
        <li data-id="{{ item.address.id }}">
            <span class="address-number">{{ forloop.counter }}.</span> 
            <span class="address-name">{{ item.address.name }}</span>
    
            {% if is_manager %}
                {% if item.address.assigned_user %}
                    {% if item.address.assigned_user.username %}
                        <span class="executor-name"> - {{ item.address.assigned_user.executorprofile.name }}</span>
                    {% else %}
                        <span class="executor-email"> - {{ item.address.assigned_user.email }}</span>
                    {% endif %}
                {% else %}
                    <span class="executor-none"> - Исполнитель не назначен</span>
                {% endif %}
            {% endif %}
    
            {% if is_manager and item.has_photos %}
                <!-- Кнопка "Детали" для менеджера, только если есть фото -->
                <button class="view-details" data-address-id="{{ item.address.id }}">Детали</button>
            {% elif is_executor %}
                <!-- Кнопка "Загрузить фото" для исполнителя -->
                <form method="post" enctype="multipart/form-data" action="{% url 'upload_photos' event.id item.address.id %}">
                    {% csrf_token %}
                    <input type="file" name="photos" accept="image/*" multiple>
                    <button type="submit">Загрузить фото</button>
                </form>
            {% endif %}
    
            <span class="hidden-coordinates">
                <span class="latitude">{{ item.address.latitude }}</span> | 
                <span class="longitude">{{ item.address.longitude }}</span>
            </span>
        </li>
        {% empty %}
        <li>Нет назначенных адресов.</li>
        {% endfor %}
    </ul>

    <!-- Модальное окно для просмотра фото -->
    <div id="photosModal" class="modal fade" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Просмотр фотографий</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- Сюда будут вставлены фото -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Закрыть</button>
                </div>
            </div>
        </div>
    </div>

    <a href="{% if is_executor %}{% url 'assigned_events_list' %}{% elif is_manager %}{% url 'events_control' %}{% else %}{% url 'home' %}{% endif %}">
        Закрыть
    </a>

    <script>
        $(document).on('click', '.view-details', function() {
            const addressId = $(this).data('address-id');

            // Сохраняем ссылку на элемент, который открыл модальное окно
            let $trigger = $(this);

            // Сделать AJAX-запрос для получения картинок
            $.ajax({
                url: `{% url 'view_photos' event.id %}?address_id=${addressId}`,
                method: 'GET',
                success: function(data) {
                    let photosHtml = '';
                    if (data.photos && data.photos.length > 0) {
                        data.photos.forEach(photo => {
                            photosHtml += `<img src="${photo.url}" alt="Фото ${photo.name} для ${photo.address_name}" style="max-width: 100%;"/><br>`;
                        });
                    } else {
                        photosHtml = '<p>Нет доступных фотографий.</p>';
                    }

                    // Показываем изображения в модальном окне
                    $('#photosModal .modal-body').html(photosHtml);
                    $('#photosModal').modal('show').on('hidden.bs.modal', function() {
                        // Возвращаем фокус на кнопку, открывшую модальное окно
                        $trigger.focus();
                    });
                },
                error: function() {
                    alert('Ошибка при загрузке фотографий.');
                }
            });
        });
        ymaps.ready(initMap);
    
        let map;
        let placemarks = [];
        let polyline;
    
        function initMap() {
            if (!map) {
                map = new ymaps.Map('map', {
                    center: [55.76, 37.64],
                    zoom: 10
                });
            }
    
            updateMap();
        }
    
        function updateMap() {
            map.geoObjects.removeAll();
            placemarks = [];
            let coordinates = [];
    
            $('#assigned-event-addresses-list li').each(function() {
                const latitude = parseFloat($(this).find('.latitude').text().trim().replace(',', '.'));
                const longitude = parseFloat($(this).find('.longitude').text().trim().replace(',', '.'));
                const name = $(this).find('.address-name').text().trim();
                const addressNumber = $(this).find('.address-number').text().trim().replace('.', '');
    
                if (!isNaN(latitude) && !isNaN(longitude)) {
                    const placemark = new ymaps.Placemark(
                        [latitude, longitude],
                        {
                            balloonContent: `<strong>Адрес ${addressNumber}</strong>: ${name}`,
                            iconContent: addressNumber
                        },
                        {
                            preset: 'islands#redStretchyIcon'
                        }
                    );
    
                    map.geoObjects.add(placemark);
                    placemarks.push(placemark);
                    coordinates.push([latitude, longitude]);
                } else {
                    console.warn('Некорректные координаты для адреса:', name);
                }
            });
    
            if (polyline) {
                map.geoObjects.remove(polyline);
            }
    
            if (coordinates.length > 1) {
                polyline = new ymaps.Polyline(coordinates, {}, {
                    strokeColor: '#0000FF',
                    strokeWidth: 3,
                    strokeOpacity: 0.5
                });
                map.geoObjects.add(polyline);
            }
        }
    
        function updateAddressNumbers() {
            $('#assigned-event-addresses-list .address-number').each(function(index) {
                $(this).text((index + 1) + '.');
            });
        }
    
        function saveNewOrder(selector) {
            const orderData = [];
            $(selector + ' li').each(function(index) {
                const addressId = $(this).data('id');
                orderData.push({ id: addressId, order: index });
            });
    
            $.ajax({
                url: "{% url 'update_address_order' %}",
                type: "POST",
                data: {
                    order: JSON.stringify(orderData),
                    model: 'EventAddress',
                    csrfmiddlewaretoken: "{{ csrf_token }}"
                },
                success: function(response) {
                    console.log('Порядок адресов события успешно сохранен.');
                },
                error: function(response) {
                    console.error('Ошибка при сохранении порядка адресов события');
                }
            });
        }
    
        $("#assigned-event-addresses-list").sortable({
            placeholder: 'ui-state-highlight',
            update: function(event, ui) {
                updateAddressNumbers();
                saveNewOrder('#assigned-event-addresses-list');
                updateMap();
            }
        }).disableSelection();

        function calculateOptimalRoute() {
            const coords = [];
            $('#assigned-event-addresses-list li').each(function() {
                const latitude = parseFloat($(this).find('.latitude').text().trim().replace(',', '.'));
                const longitude = parseFloat($(this).find('.longitude').text().trim().replace(',', '.'));
                if (!isNaN(latitude) && !isNaN(longitude)) {
                    coords.push([latitude, longitude]);
                }
            });

            const addressOrder = getOptimalRoute(coords);

            reorderAddresses(addressOrder);
            updateAddressNumbers();
            saveNewOrder('#assigned-event-addresses-list');
            updateMap();
        }

        function reorderAddresses(order) {
            const $list = $('#assigned-event-addresses-list');
            const items = $list.children('li').get();
            order.forEach((index) => {
                $list.append(items[index]);
            });
        }

        function getOptimalRoute(coords) {
            let order;
            $.ajax({
                url: "{% url 'calculate_optimal_route' %}",  // Make sure this URL pattern is created
                type: "POST",
                data: {
                    coordinates: JSON.stringify(coords),
                    csrfmiddlewaretoken: "{{ csrf_token }}"
                },
                async: false,  // To make the call synchronous and get the result immediately
                success: function(response) {
                    order = response.route;
                },
                error: function(response) {
                    console.error('Ошибка при обновлении маршрута');
                }
            });
            return order;
        }

        $('#update-route').on('click', calculateOptimalRoute);

        document.getElementById('print-addresses').addEventListener('click', function() {
        printAddressList();
    });

    function printAddressList() {
        let printWindow = window.open('', '_blank', 'width=600,height=400');
        let content = '<html><head><title>{{ event.get_event_type_display }} {{ event.project.name }}</title></head><body><h2>{{ event.project.name }}: {{ event.get_event_type_display }}</h2><p>{{ event.project.organization }} | {{ event.project.product }} | Дата: {{ event.event_date }}</p><ul>';
        
        // Формируем список адресов без координат
        $('#assigned-event-addresses-list li').each(function() {
            const addressName = $(this).find('.address-name').text().trim();
            const addressNumber = $(this).find('.address-number').text().trim();
            content += `<li>${addressNumber} ${addressName}</li>`;
        });
        
        content += '</ul></body></html>';
        
        printWindow.document.open();
        printWindow.document.write(content);
        printWindow.document.close();
        printWindow.focus();
        printWindow.print();
        printWindow.close();
    }
    </script>

</body>
</html>