<!-- templates/projects/event_detail.html -->
<!DOCTYPE html>
<html lang="ru_RU">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Детали события</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/normalize.css' %}">
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    <link rel="stylesheet" href="{% static 'css/event-detail.css' %}">
    
    <script src="{% static 'js/jquery-3.7.1.min.js' %}"></script>
    <script src="{% static 'js/jquery-ui.1.12.1.min.js' %}"></script>
    <script src="https://api-maps.yandex.ru/2.1/?apikey={{ api_key }}&lang=ru_RU" type="text/javascript"></script>
</head>
<body class="page event-detail">
    <header class="page__header">
        <nav class="nav">
            {% if is_manager %}
            <ul class="nav__list">
                <li class="nav__item">
                    <a class="nav__link nav__link--inactive" href="{% url 'profile' %}">Профиль</a>
                </li>
                <li class="nav__item">
                    <a class="nav__link nav__link--inactive" href="{% url 'manage_projects' %}">Проекты</a>
                </li>
                <li class="nav__item">
                    <a class="nav__link nav__link--active">Контроль</a>
                </li>
            </ul>
            {% endif %}
            {% if is_executor %}
            <ul class="nav__list">
                <li class="nav__item">
                    <a class="nav__link nav__link--inactive" href="{% url 'executor_profile' %}">Профиль</a>
                </li>
                <li class="nav__item">
                    <a class="nav__link nav__link--active">События</a>
                </li>
            </ul>
            {% endif %}
        </nav>
        <div class="logo">
            <img class="logo__img" src="{% static 'img/logo.png' %}" alt="Логотип">
        </div>
    </header>
    <div class="container">
        <div class="event-detail__header">
            <h1 class="page__title">{{ event.get_event_type_display }}: {{ event.project.name }}</h1>
            <a class="event-detail__close-btn page__close-btn" href="{% if is_executor %}{% url 'assigned_events_list' %}{% elif is_manager %}{% url 'events_control' %}{% else %}{% url 'home' %}{% endif %}"></a>
        </div>
        <div class="event-detail__content">
            <div class="event-detail__content-row">
                <div class="event-detail__content-col">
                    <div class="event-detail__content-cell" data-section-id="details">
                        <div class="event-detail__cell-header" data-section-id="details">
                            <h2 class="page__block-title">Детали</h2>
                        </div>
                        <div class="event-detail__cell-content" data-section-id="details">
                            <div class="event-detail__cell-content-wrap">
                                <div class="event-detail__field">
                                    <span class="event-detail__field-name">
                                        Организация:
                                    </span>
                                    <span class="event-detail__field-value">
                                        {{ event.project.organization }}
                                    </span>
                                </div>
                                <div class="event-detail__field">
                                    <span class="event-detail__field-name">
                                        Продукт:
                                    </span>
                                    <span class="event-detail__field-value">
                                        {{ event.project.product }}
                                    </span>
                                </div>
                                <div class="event-detail__field">
                                    <span class="event-detail__field-name">
                                        Кол-во фото: 
                                    </span>
                                    <span class="event-detail__field-value">
                                        {{ event.photo_count }}
                                    </span>
                                </div>
                                <div class="event-detail__field">
                                    <span class="event-detail__field-name">
                                        Дата начала: 
                                    </span>
                                    <span class="event-detail__field-value">
                                        {{ event.event_date }}
                                    </span>
                                </div>
                                <div class="event-detail__field">
                                    <span class="event-detail__field-name">
                                        Срок выполнения (в днях):
                                    </span>
                                    <span class="event-detail__field-value">
                                        {{ event.duration_days }}
                                    </span>
                                </div>
                                <div class="event-detail__field">
                                    <span class="event-detail__field-name">
                                        Описание:
                                    </span>
                                    <span class="event-detail__field-value">
                                        {{ event.description }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="event-detail__content-cell" data-section-id="appointments">
                        <div class="event-detail__cell-header" data-section-id="appointments">
                            <h2 class="page__block-title">Назначения</h2>
                        </div>
                        <div class="event-detail__cell-content" data-section-id="appointments">
                            <div class="event-detail__cell-content-wrap">
                                <div class="event-detail__appointments-btns">
                                    <button class="event-detail__update-route-btn btn" id="update-route" type="button">Обновить маршрут</button>
                                    <button class="event-detail__print-addresses-btn btn" id="print-addresses" type="button">Печать маршрута</button>
                                </div>
                                {% if is_manager %}
                                    <div class="event-detail__appointments-content">
                                        <ul class="nav-tabs" id="managerTabs" role="tablist">
                                            {% for executor, addresses in addresses_with_photos_manager.items %}
                                                {% if executor or addresses %}
                                                    <li class="nav-item">
                                                        <a class="nav-link {% if forloop.first %}active{% endif %}"
                                                        id="tab-{% if executor %}{{ executor.id }}{% else %}unassigned{% endif %}"
                                                        data-target="#executor-{% if executor %}{{ executor.id }}{% else %}unassigned{% endif %}"
                                                        role="tab">
                                                            {% if executor %}
                                                                {{ executor.name }}
                                                            {% else %}
                                                                Без назначения
                                                            {% endif %}
                                                        </a>
                                                    </li>
                                                {% endif %}
                                            {% endfor %}
                                        </ul>
                                        <div class="tab-content" id="managerTabsContent">
                                            {% for executor, addresses in addresses_with_photos_manager.items %}
                                                {% if executor or addresses %}
                                                    <div class="tab-pane {% if forloop.first %}active{% endif %}"
                                                        id="executor-{% if executor %}{{ executor.id }}{% else %}unassigned{% endif %}"
                                                        role="tabpanel">
                                                        <ul class="event-detail__addresses-list">
                                                            {% for item in addresses %}
                                                            <li class="event-detail__addresses-item" 
                                                                data-id="{{ item.address.id }}" 
                                                                data-executor-id="{{ item.executor_id }}" 
                                                                data-executor-color="{{ item.executor_color }}" 
                                                                data-address-name="{{ item.address.name }}">
                                                                <span class="address-number">={{ forloop.counter }}=</span>
                                                                <span class="address-name">{{ item.address.name }}</span>
                                                                {% if item.has_photos %}
                                                                    <button type="button" class="view-details btn" data-address-id="{{ item.address.id }}">Фото</button>
                                                                {% endif %}
                                                                <span class="hidden-coordinates">
                                                                    <span class="latitude">{{ item.address.latitude }}</span> | 
                                                                    <span class="longitude">{{ item.address.longitude }}</span>
                                                                </span>
                                                            </li>
                                                            {% empty %}
                                                                <li>Нет назначенных адресов для {% if executor %}{{ executor.name }}{% else %}категории "Без назначения"{% endif %}.</li>
                                                            {% endfor %}
                                                        </ul>
                                                    </div>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                {% endif %}
                            
                                {% if is_executor %}
                                    <ul class="event-detail__addresses-list" id="executor-event-addresses-list">
                                        {% for item in addresses_with_photos_executor %}
                                        <li class="event-detail__addresses-item accordion-header {% if item.has_photos %}has-photos{% endif %}" data-id="{{ item.address.id }}" data-executor-id="{{ item.executor_id }}" data-executor-color="{{ item.executor_color }}">
                                            <div class="accordion-header-wrap">
                                                <span class="address-number">={{ forloop.counter }}=</span> 
                                                <span class="address-name">{{ item.address.name }}</span>
                                            </div>
                            
                                            <div class="photo-upload" style="display: none;">
                                                {% if user_event_status == 'completed' %}
                                                    <span>Фотографии приняты</span>
                                                {% elif user_event_status != 'in_progress' %}
                                                    <span>Для загрузки фото необходим статус "в работе"</span>
                                                {% else %}
                                                    {% if item.has_photos %}
                                                        <div class="photo-upload__has-photo">
                                                            <span>Фото загружено</span>
                                                            <button class="refresh-upload-form btn" data-url="{% url 'upload_photos' event.id item.address.id %}">Перезагрузить</button>
                                                        </div>
                                                    {% else %}
                                                        <form class="photo-upload__form" method="post" enctype="multipart/form-data" action="{% url 'upload_photos' event.id item.address.id %}">
                                                            {% csrf_token %}
                                                            <div class="photo-upload__form-wrap">
                                                                <!-- Скрытый input для выбора файлов -->
                                                                <input type="file" name="photos" id="fileInput" accept="image/*" multiple style="display: none;">
                                                                
                                                                <!-- Кастомная кнопка для вызова input -->
                                                                <button class="photo-upload__choose-btn btn" type="button" id="customButton">Выбрать</button>
                                                                
                                                                <!-- Текстовое поле для отображения выбранных файлов -->
                                                                <span class="photo-upload__fileLabel" id="fileLabel">фото</span>
                                                                
                                                                <!-- Другие элементы формы -->
                                                                <label class="photo-upload__form-label">
                                                                    <input type="checkbox" name="force_mjeure"> Форс-мажор
                                                                </label>
                                                            </div>
                                                            <button class="photo-upload__submit-btn btn" type="submit">Загрузить</button>
                                                        </form>
                                                    {% endif %}
                                                {% endif %}
                                            </div>
                            
                                            <span class="hidden-coordinates">
                                                <span class="latitude">{{ item.address.latitude }}</span> | 
                                                <span class="longitude">{{ item.address.longitude }}</span>
                                            </span>
                                        </li>
                                        {% empty %}
                                        <li>Нет назначенных адресов.</li>
                                        {% endfor %}
                                    </ul>
                                {% endif %}
                            
                                <!-- Модальное окно для просмотра фото -->
                                <div id="photosModal" class="modal" style="display: none;">
                                    <div class="modal-content">
                                        <span class="modal-close-btn"></span>
                                        <div class="photo-viewer">
                                            <button class="prev-photo"></button>
                                            <img class="modal__img" id="photoDisplay" src="" alt="Фото"/>
                                            <button class="next-photo"></button>
                                        </div>
                                    </div>
                                </div>
                                
                                {% if is_executor %}
                                    {% if user_event_status == 'completed' %}
                                        <p>{{ event.get_event_type_display }}: завершён</p>
                                    {% else %}
                                        <button class="event-detail__complete-event-btn btn" id="complete-event">Завершить</button>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            
                <div class="event-detail__content-col">
                    <div class="map-wrap">
                        <div id="map" style="width: 100%; height: 100%;"></div>
                    </div>
                </div>

            </div>
        </div>
    
    </div>

    <script type="text/javascript">
        // Передача данных из Django в JavaScript
        window.csrfToken = '{{ csrf_token }}';
        window.isManager = "{{ is_manager|yesno:'true,false' }}";
        window.isExecutor = "{{ is_executor|yesno:'true,false' }}";
        window.eventId = "{{ event.id }}";
        window.eventTitle = "{{ event.get_event_type_display }}: {{ event.project.name }}";
        window.organization = "{{ event.project.organization }}";
        window.product = "{{ event.project.product }}";
        window.photoCount = "{{ event.photo_count }}";
        window.eventDate = "{{ event.event_date }}";
        window.allowedPhotoCount = "{{ event.photo_count }}";
        window.viewPhotosUrl = "{% url 'view_photos' event.id %}";
        window.completeEventUrl = "{% url 'complete_event' %}";
        window.updateAddressOrderUrl = "{% url 'update_address_order' %}";
        window.calculateOptimalRouteUrl = "{% url 'calculate_optimal_route' %}";
    </script>

    <script src="{% static 'js/event_detail.js' %}"></script>

</body>
<footer class="page__footer">

</footer>
</html>